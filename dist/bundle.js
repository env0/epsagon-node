"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var e=_interopDefault(require("google-protobuf")),t=_interopDefault(require("uuid4")),r=_interopDefault(require("axios")),a=_interopDefault(require("os")),n=_interopDefault(require("fs")),s=_interopDefault(require("require-in-the-middle")),o=_interopDefault(require("events")),i=_interopDefault(require("https")),p=_interopDefault(require("http")),c=_interopDefault(require("md5")),u=_interopDefault(require("json.sortify")),d=_interopDefault(require("util")),l=_interopDefault(require("shimmer")),g=_interopDefault(require("zlib")),f=_interopDefault(require("uuid-parse")),h=_interopDefault(require("path")),_=_interopDefault(require("url")),m=_interopDefault(require("dns"));function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var E=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.Exception",null,n),proto.Exception=function(t){e.Message.initialize(this,t,0,-1,null,null)},a.inherits(proto.Exception,e.Message),a.DEBUG&&!COMPILED&&(proto.Exception.displayName="proto.Exception"),e.Message.GENERATE_TO_OBJECT&&(proto.Exception.prototype.toObject=function(e){return proto.Exception.toObject(e,this)},proto.Exception.toObject=function(t,r){var a,n={type:e.Message.getFieldWithDefault(r,1,""),message:e.Message.getFieldWithDefault(r,2,""),traceback:e.Message.getFieldWithDefault(r,3,""),time:+e.Message.getFieldWithDefault(r,4,0),additionalDataMap:(a=r.getAdditionalDataMap())?a.toObject(t,void 0):[]};return t&&(n.$jspbMessageInstance=r),n}),proto.Exception.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Exception;return proto.Exception.deserializeBinaryFromReader(a,r)},proto.Exception.deserializeBinaryFromReader=function(t,r){for(;r.nextField()&&!r.isEndGroup();){switch(r.getFieldNumber()){case 1:var a=r.readString();t.setType(a);break;case 2:a=r.readString();t.setMessage(a);break;case 3:a=r.readString();t.setTraceback(a);break;case 4:a=r.readDouble();t.setTime(a);break;case 5:a=t.getAdditionalDataMap();r.readMessage(a,(function(t,r){e.Map.deserializeBinary(t,r,e.BinaryReader.prototype.readString,e.BinaryReader.prototype.readString)}));break;default:r.skipField()}}return t},proto.Exception.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Exception.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Exception.serializeBinaryToWriter=function(t,r){var a=void 0;(a=t.getType()).length>0&&r.writeString(1,a),(a=t.getMessage()).length>0&&r.writeString(2,a),(a=t.getTraceback()).length>0&&r.writeString(3,a),0!==(a=t.getTime())&&r.writeDouble(4,a),(a=t.getAdditionalDataMap(!0))&&a.getLength()>0&&a.serializeBinary(5,r,e.BinaryWriter.prototype.writeString,e.BinaryWriter.prototype.writeString)},proto.Exception.prototype.getType=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Exception.prototype.setType=function(t){e.Message.setProto3StringField(this,1,t)},proto.Exception.prototype.getMessage=function(){return e.Message.getFieldWithDefault(this,2,"")},proto.Exception.prototype.setMessage=function(t){e.Message.setProto3StringField(this,2,t)},proto.Exception.prototype.getTraceback=function(){return e.Message.getFieldWithDefault(this,3,"")},proto.Exception.prototype.setTraceback=function(t){e.Message.setProto3StringField(this,3,t)},proto.Exception.prototype.getTime=function(){return+e.Message.getFieldWithDefault(this,4,0)},proto.Exception.prototype.setTime=function(t){e.Message.setProto3FloatField(this,4,t)},proto.Exception.prototype.getAdditionalDataMap=function(t){return e.Message.getMapField(this,5,t,null)},proto.Exception.prototype.clearAdditionalDataMap=function(){this.getAdditionalDataMap().clear()},a.object.extend(r,proto)})),b=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.ErrorCode",null,n),proto.ErrorCode={OK:0,ERROR:1,EXCEPTION:2,TIMEOUT:3},a.object.extend(r,proto)})),y=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.Event",null,n),a.exportSymbol("proto.Resource",null,n),proto.Resource=function(t){e.Message.initialize(this,t,0,-1,null,null)},a.inherits(proto.Resource,e.Message),a.DEBUG&&!COMPILED&&(proto.Resource.displayName="proto.Resource"),e.Message.GENERATE_TO_OBJECT&&(proto.Resource.prototype.toObject=function(e){return proto.Resource.toObject(e,this)},proto.Resource.toObject=function(t,r){var a,n={name:e.Message.getFieldWithDefault(r,1,""),type:e.Message.getFieldWithDefault(r,2,""),operation:e.Message.getFieldWithDefault(r,3,""),metadataMap:(a=r.getMetadataMap())?a.toObject(t,void 0):[]};return t&&(n.$jspbMessageInstance=r),n}),proto.Resource.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Resource;return proto.Resource.deserializeBinaryFromReader(a,r)},proto.Resource.deserializeBinaryFromReader=function(t,r){for(;r.nextField()&&!r.isEndGroup();){switch(r.getFieldNumber()){case 1:var a=r.readString();t.setName(a);break;case 2:a=r.readString();t.setType(a);break;case 3:a=r.readString();t.setOperation(a);break;case 4:a=t.getMetadataMap();r.readMessage(a,(function(t,r){e.Map.deserializeBinary(t,r,e.BinaryReader.prototype.readString,e.BinaryReader.prototype.readString)}));break;default:r.skipField()}}return t},proto.Resource.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Resource.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Resource.serializeBinaryToWriter=function(t,r){var a=void 0;(a=t.getName()).length>0&&r.writeString(1,a),(a=t.getType()).length>0&&r.writeString(2,a),(a=t.getOperation()).length>0&&r.writeString(3,a),(a=t.getMetadataMap(!0))&&a.getLength()>0&&a.serializeBinary(4,r,e.BinaryWriter.prototype.writeString,e.BinaryWriter.prototype.writeString)},proto.Resource.prototype.getName=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Resource.prototype.setName=function(t){e.Message.setProto3StringField(this,1,t)},proto.Resource.prototype.getType=function(){return e.Message.getFieldWithDefault(this,2,"")},proto.Resource.prototype.setType=function(t){e.Message.setProto3StringField(this,2,t)},proto.Resource.prototype.getOperation=function(){return e.Message.getFieldWithDefault(this,3,"")},proto.Resource.prototype.setOperation=function(t){e.Message.setProto3StringField(this,3,t)},proto.Resource.prototype.getMetadataMap=function(t){return e.Message.getMapField(this,4,t,null)},proto.Resource.prototype.clearMetadataMap=function(){this.getMetadataMap().clear()},proto.Event=function(t){e.Message.initialize(this,t,0,-1,null,null)},a.inherits(proto.Event,e.Message),a.DEBUG&&!COMPILED&&(proto.Event.displayName="proto.Event"),e.Message.GENERATE_TO_OBJECT&&(proto.Event.prototype.toObject=function(e){return proto.Event.toObject(e,this)},proto.Event.toObject=function(t,r){var a,n={id:e.Message.getFieldWithDefault(r,1,""),startTime:+e.Message.getFieldWithDefault(r,2,0),resource:(a=r.getResource())&&proto.Resource.toObject(t,a),origin:e.Message.getFieldWithDefault(r,4,""),duration:+e.Message.getFieldWithDefault(r,5,0),errorCode:e.Message.getFieldWithDefault(r,6,0),exception:(a=r.getException())&&E.Exception.toObject(t,a)};return t&&(n.$jspbMessageInstance=r),n}),proto.Event.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Event;return proto.Event.deserializeBinaryFromReader(a,r)},proto.Event.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readString();e.setId(r);break;case 2:r=t.readDouble();e.setStartTime(r);break;case 3:r=new proto.Resource;t.readMessage(r,proto.Resource.deserializeBinaryFromReader),e.setResource(r);break;case 4:r=t.readString();e.setOrigin(r);break;case 5:r=t.readDouble();e.setDuration(r);break;case 6:r=t.readEnum();e.setErrorCode(r);break;case 7:r=new E.Exception;t.readMessage(r,E.Exception.deserializeBinaryFromReader),e.setException(r);break;default:t.skipField()}}return e},proto.Event.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Event.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Event.serializeBinaryToWriter=function(e,t){var r=void 0;(r=e.getId()).length>0&&t.writeString(1,r),0!==(r=e.getStartTime())&&t.writeDouble(2,r),null!=(r=e.getResource())&&t.writeMessage(3,r,proto.Resource.serializeBinaryToWriter),(r=e.getOrigin()).length>0&&t.writeString(4,r),0!==(r=e.getDuration())&&t.writeDouble(5,r),0!==(r=e.getErrorCode())&&t.writeEnum(6,r),null!=(r=e.getException())&&t.writeMessage(7,r,E.Exception.serializeBinaryToWriter)},proto.Event.prototype.getId=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Event.prototype.setId=function(t){e.Message.setProto3StringField(this,1,t)},proto.Event.prototype.getStartTime=function(){return+e.Message.getFieldWithDefault(this,2,0)},proto.Event.prototype.setStartTime=function(t){e.Message.setProto3FloatField(this,2,t)},proto.Event.prototype.getResource=function(){return e.Message.getWrapperField(this,proto.Resource,3)},proto.Event.prototype.setResource=function(t){e.Message.setWrapperField(this,3,t)},proto.Event.prototype.clearResource=function(){this.setResource(void 0)},proto.Event.prototype.hasResource=function(){return null!=e.Message.getField(this,3)},proto.Event.prototype.getOrigin=function(){return e.Message.getFieldWithDefault(this,4,"")},proto.Event.prototype.setOrigin=function(t){e.Message.setProto3StringField(this,4,t)},proto.Event.prototype.getDuration=function(){return+e.Message.getFieldWithDefault(this,5,0)},proto.Event.prototype.setDuration=function(t){e.Message.setProto3FloatField(this,5,t)},proto.Event.prototype.getErrorCode=function(){return e.Message.getFieldWithDefault(this,6,0)},proto.Event.prototype.setErrorCode=function(t){e.Message.setProto3EnumField(this,6,t)},proto.Event.prototype.getException=function(){return e.Message.getWrapperField(this,E.Exception,7)},proto.Event.prototype.setException=function(t){e.Message.setWrapperField(this,7,t)},proto.Event.prototype.clearException=function(){this.setException(void 0)},proto.Event.prototype.hasException=function(){return null!=e.Message.getField(this,7)},a.object.extend(r,proto)})),v=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.Trace",null,n),proto.Trace=function(t){e.Message.initialize(this,t,0,-1,proto.Trace.repeatedFields_,null)},a.inherits(proto.Trace,e.Message),a.DEBUG&&!COMPILED&&(proto.Trace.displayName="proto.Trace"),proto.Trace.repeatedFields_=[3,4],e.Message.GENERATE_TO_OBJECT&&(proto.Trace.prototype.toObject=function(e){return proto.Trace.toObject(e,this)},proto.Trace.toObject=function(t,r){var a={appName:e.Message.getFieldWithDefault(r,1,""),token:e.Message.getFieldWithDefault(r,2,""),eventList:e.Message.toObjectList(r.getEventList(),y.Event.toObject,t),exceptionList:e.Message.toObjectList(r.getExceptionList(),E.Exception.toObject,t),version:e.Message.getFieldWithDefault(r,5,""),platform:e.Message.getFieldWithDefault(r,6,"")};return t&&(a.$jspbMessageInstance=r),a}),proto.Trace.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Trace;return proto.Trace.deserializeBinaryFromReader(a,r)},proto.Trace.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readString();e.setAppName(r);break;case 2:r=t.readString();e.setToken(r);break;case 3:r=new y.Event;t.readMessage(r,y.Event.deserializeBinaryFromReader),e.addEvent(r);break;case 4:r=new E.Exception;t.readMessage(r,E.Exception.deserializeBinaryFromReader),e.addException(r);break;case 5:r=t.readString();e.setVersion(r);break;case 6:r=t.readString();e.setPlatform(r);break;default:t.skipField()}}return e},proto.Trace.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Trace.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Trace.serializeBinaryToWriter=function(e,t){var r=void 0;(r=e.getAppName()).length>0&&t.writeString(1,r),(r=e.getToken()).length>0&&t.writeString(2,r),(r=e.getEventList()).length>0&&t.writeRepeatedMessage(3,r,y.Event.serializeBinaryToWriter),(r=e.getExceptionList()).length>0&&t.writeRepeatedMessage(4,r,E.Exception.serializeBinaryToWriter),(r=e.getVersion()).length>0&&t.writeString(5,r),(r=e.getPlatform()).length>0&&t.writeString(6,r)},proto.Trace.prototype.getAppName=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Trace.prototype.setAppName=function(t){e.Message.setProto3StringField(this,1,t)},proto.Trace.prototype.getToken=function(){return e.Message.getFieldWithDefault(this,2,"")},proto.Trace.prototype.setToken=function(t){e.Message.setProto3StringField(this,2,t)},proto.Trace.prototype.getEventList=function(){return e.Message.getRepeatedWrapperField(this,y.Event,3)},proto.Trace.prototype.setEventList=function(t){e.Message.setRepeatedWrapperField(this,3,t)},proto.Trace.prototype.addEvent=function(t,r){return e.Message.addToRepeatedWrapperField(this,3,t,proto.Event,r)},proto.Trace.prototype.clearEventList=function(){this.setEventList([])},proto.Trace.prototype.getExceptionList=function(){return e.Message.getRepeatedWrapperField(this,E.Exception,4)},proto.Trace.prototype.setExceptionList=function(t){e.Message.setRepeatedWrapperField(this,4,t)},proto.Trace.prototype.addException=function(t,r){return e.Message.addToRepeatedWrapperField(this,4,t,proto.Exception,r)},proto.Trace.prototype.clearExceptionList=function(){this.setExceptionList([])},proto.Trace.prototype.getVersion=function(){return e.Message.getFieldWithDefault(this,5,"")},proto.Trace.prototype.setVersion=function(t){e.Message.setProto3StringField(this,5,t)},proto.Trace.prototype.getPlatform=function(){return e.Message.getFieldWithDefault(this,6,"")},proto.Trace.prototype.setPlatform=function(t){e.Message.setProto3StringField(this,6,t)},a.object.extend(r,proto)}));function createTimestampFromTime(e){return e/1e3}var $,T={createTimestampFromTime:createTimestampFromTime,createTimestamp:function(){return createTimestampFromTime(Date.now())},createDurationTimestamp:function(e){return createTimestampFromTime(Date.now()-e)},reflectPromise:function(e){return e.then(e=>({value:e,status:"resolved"})).catch(e=>({error:e,status:"rejected"}))},debugLog:function(...e){"TRUE"===(process.env.EPSAGON_DEBUG||"").toUpperCase()&&console.log("[EPSAGON]",...e)},printWarning:function(...e){console.warn(...e)},printError:function(...e){console.error(...e)},makeQueryablePromise:function(e){if(e.isResolved)return e;let t=!0,r=!1,a=!1;const n=e.then(e=>(a=!0,t=!1,e),e=>{throw r=!0,t=!1,e});return n.isFulfilled=()=>a,n.isPending=()=>t,n.isRejected=()=>r,n},flatten:function(e){const t={};return function step(e,r,a){const n=a||1;Object.keys(e).forEach(a=>{const s=e[a];if(null==s)return null;const o=Array.isArray(s),i=Object.prototype.toString.call(s),p="[object Object]"===i||"[object Array]"===i,c=r?r+"."+a:a;return!o&&!Buffer.isBuffer(s)&&p&&Object.keys(s).length?step(s,c,n+1):(null!=s&&["string","number","boolean"].includes(typeof s)&&(t[c]=s),null)})}(e),t},getLastSplittedItem:(e,t)=>{const r=e&&e.split(t)||[];return r[r.length-1]},isPromise:function(e){return!!e&&"function"==typeof e.then},isLambdaEnv:!!process.env.AWS_LAMBDA_FUNCTION_NAME,getValueIfExist:function(e,t){return t in e?e[t]:void 0},truncateMessage:function(e,t){return e.length<=t?e:e.slice(0,t)}},x="Epsagon Instrumentation for Node.js",S=["serverless","epsagon","tracing","distributed-tracing","lambda","aws-lambda","debugging","monitoring"],A="Epsagon Team <support@epsagon.com>",M={pretest:"./scripts/build_peg.sh",test:"nyc --reporter=text ./scripts/run_tests.sh","lint:js":"eslint --max-warnings=0 ./src/ ./examples/ ./test/unit_tests ./index.js -f table --ext .js --ext .jsx","lint:js:fix":"eslint --max-warnings=0 ./src/ ./examples/ ./test/unit_tests ./index.js -f table --ext .js --ext .jsx --fix",lint:"npm run lint:js","build:dev":"./scripts/build_peg.sh && rollup -c",build:"./scripts/build_peg.sh && NODE_ENV=production rollup -c",clean:"rm -r dist/",prepublishOnly:"npm run build","semantic-release":"semantic-release"},R={url:"https://github.com/epsagon/epsagon-node/issues"},C="https://github.com/epsagon/epsagon-node#readme",O={type:"git",url:"https://github.com/epsagon/epsagon-node.git"},w="dist/bundle.js",N=["dist"],L={hooks:{"commit-msg":"commitlint -E HUSKY_GIT_PARAMS"}},I={"@babel/runtime":"^7.4.5","@commitlint/cli":"^9.1.2","@commitlint/config-angular":"^7.1.2","@commitlint/config-conventional":"^7.1.2","aws-sdk":"^2.197.0","body-parser":"^1.19.0",chai:"^4.1.2","chai-as-promised":"^7.1.1",dotenv:"^8.2.0",eslint:"^4.18.0","eslint-config-airbnb":"^17.1.0","eslint-plugin-chai-friendly":"^0.4.1","eslint-plugin-import":"^2.14.0","eslint-plugin-json":"^1.2.1","eslint-plugin-jsx-a11y":"^6.1.1","eslint-plugin-mocha":"^4.11.0","eslint-plugin-react":"^7.11.0",express:"^4.17.1","express-session":"^1.17.1",husky:"^1.1.0","ldap-server-mock":"^3.0.0",ldapjs:"^2.1.0",lolex:"^3.0.0",mocha:"^5.0.4",mongodb:"^3.1.13",mysql:"^2.16.0",mysql2:"^1.6.4",nyc:"^15.1.0",pegjs:"^0.10.0",pg:"^7.6.0","pg-pool":"^2.0.3",proxyquire:"^2.0.1",randomstring:"^1.1.5",redis:"^2.8.0",request:"^2.88.2","request-promise-native":"^1.0.7",rollup:"^0.66.6","rollup-plugin-commonjs":"^9.1.8","rollup-plugin-copy":"^3.1.0","rollup-plugin-eslint":"^5.0.0","rollup-plugin-json":"^3.1.0","rollup-plugin-terser":"^7.0.1","semantic-release":"^17.3.7",semver:"^7.3.4","simple-oauth2":"^4.2.0",sinon:"^4.3.0","uglify-es":"^3.3.9",underscore:"^1.12.0"},D={axios:"^0.21.1","google-protobuf":"^3.5.0","json.sortify":"^2.2.2",md5:"^2.2.1","require-in-the-middle":"^5.0.3",shimmer:"^1.2.1","uuid-parse":"^1.1.0",uuid4:"^1.0.0"},P={name:"epsagon",version:"0.0.0-development",description:x,keywords:S,author:A,license:"MIT",scripts:M,bugs:R,homepage:C,repository:O,main:w,files:N,husky:L,devDependencies:I,dependencies:D},k=(($=Object.freeze({name:"epsagon",version:"0.0.0-development",description:x,keywords:S,author:A,license:"MIT",scripts:M,bugs:R,homepage:C,repository:O,main:w,files:N,husky:L,devDependencies:I,dependencies:D,default:P}))&&$.default||$).version;let W=process.env.AWS_REGION;void 0===W&&(W="us-east-1");var q={VERSION:k,REGION:W,LOCAL_URL:"http://localhost:3000",TRACE_COLLECTOR_URL:`https://${W}.tc.epsagon.com`,COLD_START:!0,STEP_ID_NAME:"Epsagon",EPSAGON_EVENT_ID_KEY:"_epsagon_event_id",MAX_VALUE_CHARS:3072,MAX_LABEL_SIZE:10240,MAX_HTTP_VALUE_SIZE:10240,MAX_TRACE_SIZE_BYTES:process.env.EPSAGON_MAX_TRACE_SIZE?parseInt(process.env.EPSAGON_MAX_TRACE_SIZE,10):65536,DEFAULT_SAMPLE_RATE:1,DEFAULT_BATCH_SIZE:5,MAX_TRACE_WAIT:5e3,BATCH_SIZE_BYTES_HARD_LIMIT:655360,QUEUE_SIZE_BYTES_HARD_LIMIT:10485760,EPSAGON_HEADER:"epsagon-trace-id",LAMBDA_DEFAULT_NODE_MODULES_PATH:"/var/task/node_modules",STRONG_ID_KEYS:["key","request_id","requestid","request-id","steps_dict","message_id","etag","item_hash","sequence_number","trace_id","job_id","activation_id","http_trace_id","id","aws.sqs.message_id","x-amz-request-id","object_key","object_etag","aws.requestId","aws.s3.key","aws.s3.etag","aws.kinesis.sequence_number","request_trace_id","logging_tracing_enabled","CLOUDWATCH_LOG_GROUP_NAME","CLOUDWATCH_LOG_STREAM_NAME","log_stream_name","log_group_name","function_version","memory","aws_account","cold_start","region","status_code"],traceUrl:(e,t)=>`https://app.epsagon.com/trace/${e}?timestamp=${t}`,lambdaTraceUrl:(e,t,r,a,n)=>`https://app.epsagon.com/functions/${e}/${t}/${r}?requestId=${a}&requestTime=${n}`},B=createCommonjsModule((function(e){e.exports.HTTP_ERR_CODE=parseInt(process.env.EPSAGON_HTTP_ERR_CODE,10)||400,e.exports.processIgnoredKey=function(e){return e.toLowerCase().replace("-","").replace("_","").replace(/\s/g,"")};const processIgnoredKeys=t=>t.map(t=>"string"==typeof t?e.exports.processIgnoredKey(t):t),t={token:process.env.EPSAGON_TOKEN||"",appName:process.env.EPSAGON_APP_NAME||"Application",metadataOnly:"TRUE"===(process.env.EPSAGON_METADATA||"").toUpperCase(),useSSL:"TRUE"===(process.env.EPSAGON_SSL||"TRUE").toUpperCase(),traceCollectorURL:process.env.EPSAGON_COLLECTOR_URL||q.TRACE_COLLECTOR_URL,isEpsagonDisabled:"TRUE"===(process.env.DISABLE_EPSAGON||"").toUpperCase(),urlPatternsToIgnore:[],internalSampleRate:q.DEFAULT_SAMPLE_RATE,labels:{},sendOnlyErrors:"TRUE"===(process.env.EPSAGON_SEND_TRACE_ON_ERROR||"").toUpperCase(),removeIgnoredKeys:"TRUE"===(process.env.EPSAGON_REMOVE_IGNORED_KEYS||"").toUpperCase(),sendTimeout:1e3*(Number(process.env.EPSAGON_SEND_TIMEOUT_SEC)||1),decodeHTTP:"TRUE"===(process.env.EPSAGON_DECODE_HTTP||"TRUE").toUpperCase(),disableHttpResponseBodyCapture:"TRUE"===(process.env.EPSAGON_DISABLE_HTTP_RESPONSE||"").toUpperCase(),loggingTracingEnabled:"TRUE"===(process.env.EPSAGON_LOGGING_TRACING_ENABLED||(!T.isLambdaEnv).toString()).toUpperCase(),sendBatch:"TRUE"===(process.env.EPSAGON_SEND_BATCH||(!T.isLambdaEnv).toString()).toUpperCase(),batchSize:Number(process.env.EPSAGON_BATCH_SIZE)||q.DEFAULT_BATCH_SIZE,maxTraceWait:Number(process.env.EPSAGON_MAX_TRACE_WAIT)||q.MAX_TRACE_WAIT,maxBatchSizeBytes:q.BATCH_SIZE_BYTES_HARD_LIMIT,maxQueueSizeBytes:q.QUEUE_SIZE_BYTES_HARD_LIMIT,get isEpsagonPatchDisabled(){return this.isEpsagonDisabled||"TRUE"===(process.env.DISABLE_EPSAGON_PATCH||"").toUpperCase()},get sampleRate(){return this.internalSampleRate},set sampleRate(e){const t=parseFloat(e);Number.isNaN(t)||(this.internalSampleRate=t)}};process.env.EPSAGON_SAMPLE_RATE&&(t.sampleRate=process.env.EPSAGON_SAMPLE_RATE),process.env.EPSAGON_URLS_TO_IGNORE&&(t.urlPatternsToIgnore=process.env.EPSAGON_URLS_TO_IGNORE.split(",")),process.env.EPSAGON_IGNORED_KEYS&&(t.ignoredKeys=processIgnoredKeys(process.env.EPSAGON_IGNORED_KEYS.split(","))),"FALSE"===(process.env.EPSAGON_SSL||"TRUE").toUpperCase()&&(t.traceCollectorURL=t.traceCollectorURL.replace("https:","http:")),"TRUE"===(process.env.EPSAGON_SSL||"TRUE").toUpperCase()&&(t.traceCollectorURL=t.traceCollectorURL.replace("http:","https:")),process.env.EPSAGON_PATCH_WHITELIST&&(t.patchWhitelist=process.env.EPSAGON_PATCH_WHITELIST.split(",")),e.exports.getConfig=function(){return t},e.exports.setConfig=function(r){if(void 0!==r){if(r.token&&(t.token=r.token),r.isEpsagonDisabled&&(t.isEpsagonDisabled=r.isEpsagonDisabled),r.appName&&(t.appName=r.appName),void 0!==r.metadataOnly&&null!=r.metadataOnly&&(t.metadataOnly=r.metadataOnly),r.traceCollectorURL&&(t.traceCollectorURL=r.traceCollectorURL),!1===r.useSSL&&(t.traceCollectorURL=t.traceCollectorURL.replace("https:","http:"),t.useSSL=r.useSSL),r.useSSL&&(t.traceCollectorURL=t.traceCollectorURL.replace("http:","https:"),t.useSSL=r.useSSL),r.useLocalCollector&&(t.traceCollectorURL=q.LOCAL_URL),r.urlPatternsToIgnore&&(t.urlPatternsToIgnore=r.urlPatternsToIgnore),r.sendOnlyErrors&&(t.sendOnlyErrors=r.sendOnlyErrors),r.httpErrorStatusCode&&(e.exports.HTTP_ERR_CODE=r.httpErrorStatusCode),!1===r.decodeHTTP&&(t.decodeHTTP=r.decodeHTTP),r.disableHttpResponseBodyCapture&&(t.disableHttpResponseBodyCapture=r.disableHttpResponseBodyCapture),r.ignoredKeys&&Array.isArray(r.ignoredKeys)){const e=r.ignoredKeys.filter(e=>"string"==typeof e||e instanceof RegExp);e.length!==r.ignoredKeys.length&&T.printWarning("Epsagon deprecation warning: ignoredKeys supports only strings and RegExp objects, other values will be ignored. received ignoredKeys:",r.ignoredKeys),t.ignoredKeys=processIgnoredKeys(e)}r.removeIgnoredKeys&&(t.removeIgnoredKeys=r.removeIgnoredKeys),null!==r.sampleRate&&void 0!==t.sampleRate&&(t.sampleRate=r.sampleRate),Number(r.sendTimeout)&&(t.sendTimeout=Number(r.sendTimeout)),"boolean"==typeof r.sendBatch&&(t.sendBatch=r.sendBatch),Number(r.batchSize)&&(t.batchSize=Number(r.batchSize)),Number(r.maxTraceWait)&&(t.maxTraceWait=Number(r.maxTraceWait)),Number(r.maxBatchSizeBytes)&&(Number(r.maxBatchSizeBytes)>q.QUEUE_SIZE_BYTES_HARD_LIMIT?T.debugLog(`User configured maxBatchSizeBytes exceeded batch size hard limit of ${q.BATCH_SIZE_BYTES_HARD_LIMIT} Bytes`):t.maxBatchSizeBytes=Number(r.maxBatchSizeBytes)),Number(r.maxQueueSizeBytes)&&(Number(r.maxQueueSizeBytes)>q.QUEUE_SIZE_BYTES_HARD_LIMIT?T.debugLog(`User configured maxQueueSizeBytes exceeded queue size hard limit of ${q.QUEUE_SIZE_BYTES_HARD_LIMIT} Bytes`):t.maxQueueSizeBytes=Number(r.maxQueueSizeBytes)),r.labels&&(t.labels=T.flatten([...r.labels].reduce((e,t)=>{const[r,a]=t;return{...e,[r]:a}},{})))}}})),j=(B.HTTP_ERR_CODE,B.processIgnoredKey,B.getConfig,B.setConfig,createCommonjsModule((function(e){e.exports.setException=function(e,t,r=!0,a=!1){try{e.setErrorCode(a?b.ErrorCode.OK:b.ErrorCode.EXCEPTION);const n=new E.Exception([t.name,t.message,t.stack,T.createTimestamp()]);e.setException(n),n.getAdditionalDataMap().set("handled",r),n.getAdditionalDataMap().set("warning",a)}catch(e){pe.addException(e)}},e.exports.markAsTimeout=function(e){e.setErrorCode(b.ErrorCode.TIMEOUT)},e.exports.addToMetadata=function(e,t,r={}){const a=e.getResource(),n=a&&a.getMetadataMap();n&&(Object.keys(t).forEach(e=>{n.set(e,t[e])}),B.getConfig().metadataOnly||Object.keys(r).forEach(e=>{n.set(e,r[e])}))},e.exports.addObjectToMetadata=function(e,t,r,a=[]){let n=r;if(!B.getConfig().metadataOnly&&a.length>0){const s=Object.getOwnPropertyNames(r).filter(e=>!a.includes(e));n=Object.assign(...s.map(e=>({[e]:r[e]}))),e.getResource().getMetadataMap().set(t,JSON.stringify(n))}},e.exports.addLabelToMetadata=function(e,t,r){const a=e.getResource().getMetadataMap().get("labels");let n=null;void 0!==a?(n=JSON.parse(a),n[t]=r):n={[t]:r};const s=JSON.stringify(n);s.length<=q.MAX_LABEL_SIZE&&e.getResource().getMetadataMap().set("labels",s)},e.exports.initializeEvent=function(e,r,a,n){const s=Date.now(),o=new y.Resource([r,e,a]),i=new y.Event([`${e}-${t()}`,T.createTimestampFromTime(s),null,n,0,b.ErrorCode.OK]);return i.setResource(o),{slsEvent:i,startTime:s}},e.exports.finalizeEvent=function(e,t,r,a={},n={}){try{r&&this.setException(e,r),this.addToMetadata(e,a,n),e.setDuration(T.createDurationTimestamp(t))}catch(e){pe.addException(e)}},e.exports.createTraceIdMetadata=function(r){e.exports.addToMetadata(r,{trace_id:t()})}})));j.setException,j.markAsTimeout,j.addToMetadata,j.addObjectToMetadata,j.addLabelToMetadata,j.initializeEvent,j.finalizeEvent,j.createTraceIdMetadata;let U=null,F=null;var ecs_hasECSMetadata=function(){return process.env.ECS_CONTAINER_METADATA_URI||!1},ecs_loadECSMetadata=function(e){if(U)return Promise.resolve(U);T.debugLog(`loading ecs meta, url: (${e})`);const t=[],a=r.get(e).then(e=>e.data).then(e=>{T.debugLog("Received metadata: "+JSON.stringify(e)),U=e&&e.Labels;const t=U&&U["com.amazonaws.ecs.cluster"];return t&&(F=t.split(":")[4]),U}).catch(e=>{T.debugLog("error fetching ecs metadata: ",e)});return t.push(a),Promise.all(t)},ecs_addECSMetadata=function(e){e&&U&&(j.addToMetadata(e,{ECS:U}),j.addToMetadata(e,{"aws.account_id":F}))};let z=null,H=null;var k8s_hasK8sMetadata=function(){return!!process.env.KUBERNETES_SERVICE_HOST},k8s_loadK8sMetadata=function(){if(z||(z=a.hostname()),!H)try{const e=n.readFileSync("/proc/self/cgroup").toString("utf-8").split("\n")[0].split("/");H=e[e.length-1]}catch(e){T.debugLog("Error loading k8s container id - cannot read cgroup file",e)}},k8s_addK8sMetadata=function(e){if(!e||!z)return;const t={is_k8s:!0,k8s_pod_name:z};H&&(t.k8s_container_id=H),j.addToMetadata(e,t)};let K=null;const G=`${process.env.AZURE_HOST||"http://169.254.169.254"}${process.env.AZURE_PATH||"/metadata/instance?api-version=2019-06-01"}`,J=process.env.AZURE_REQUEST_TIMEOUT||3e3,parseAzureTags=e=>e.split(";").reduce((e,t)=>{const[r,a]=t.split(":");return r?{...e,[r]:a}:e},{});var azure_loadAzureMetadata=function(e){if(K)return Promise.resolve(K);T.debugLog(`loading azure metadata, url: (${G})`);const t=r.CancelToken.source();setTimeout(()=>{t.cancel()},J);const a={headers:{Metadata:"True"},timeout:J,cancelToken:t.token};return r.get(G,a).then(t=>{if(T.debugLog("Received response: "+t),200===t.status){const{location:r,subscriptionId:a,tags:n,publisher:s}=t.data.compute;K={"azure.location":r,"azure.subscription_id":a,"azure.tags":parseAzureTags(n),"azure.publisher":s},e&&e({traceCollectorURL:`http://${r}.atc.epsagon.com`}),T.debugLog("Received metadata: "+K)}}).catch(()=>{T.debugLog("Could not load azure metadata")})},azure_addAzureMetadata=function(e){e&&K&&j.addToMetadata(e,Object.assign({},K))};let Q=null;const V=["instance-id","instance-type","local-ipv4","public-hostname","public-ipv4"],Z=process.env.EPSAGON_EC2_REQUEST_TIMEOUT||3e3;var ec2_loadEC2Metadata=function(){if(Q)return Promise.resolve(Q);const e=[];return T.debugLog("Loading EC2 metadata"),V.forEach(t=>{const a=r.CancelToken.source();setTimeout(()=>{a.cancel()},Z),e.push(r.get("http://169.254.169.254/latest/meta-data/"+t,{timeout:Z,cancelToken:a.token}).then(e=>{if(T.debugLog("Received response for "+t),200===e.status){const r=t.replace("-","_"),a=e.data;Q||(Q={}),Q["aws.ec2."+r]=a,T.debugLog(`${r} stored with: ${a}`)}return t}).catch(()=>{T.debugLog("Could not load EC2 metadata for "+t)}))}),Promise.all(e)},ec2_addEC2Metadata=function(e){e&&Q&&j.addToMetadata(e,Object.assign({},Q))};let X=null;const tryRequire=e=>{let t;const r="function"==typeof __webpack_require__?__non_webpack_require__:require;try{t=r.resolve(e),X=null}catch(e){X=e}if(t)try{return r(t)}catch(e){X=e}};tryRequire.lastError=()=>X;var Y=tryRequire;const ee=Y("aws-sdk/global"),te=Y("aws-sdk/clients/sts"),re=[];function onWinstonCloudwatchRequire(e){if(T.debugLog("winston-cloudwatch required"),"function"!=typeof e)return T.debugLog("winston-cloudwatch got non-function exports",typeof e,e),e;if(e.__epsagon_wrapped)return T.debugLog("winston-cloudwatch already hooked"),e;function wrapper(...t){const[r]=t;try{T.debugLog("winston-cloudwatch instance created"),function(e){if(!ee)return Promise.resolve();const t={};t.log_group_name=e.logGroupName,t.log_stream_name=e.logStreamName;const r=new te,a=e.cloudWatchLogs&&e.cloudWatchLogs.config||{};return t.region=e.awsRegion||a.region||ee.config.region||process.env.AWS_REGION,r.getCallerIdentity().promise().then(e=>(t.account_id=e.Account,t))}(r).then(e=>re.push(e)).catch(e=>pe.addException(e))}catch(e){T.debugLog("failed to set cloudwatch-winston log parameters",e),pe.addException(e)}return e.apply(this,t)}return wrapper.prototype=Object.create(e.prototype),e.__epsagon_wrapped=!0,T.debugLog("winston-cloudwatch require patching done"),wrapper}var ae={init(){T.debugLog("hooking winston-cloudwatch"),s(["winston-cloudwatch"],onWinstonCloudwatchRequire),T.debugLog("hooked winston-cloudwatch")},additionalMetadata:()=>re.length?{"aws.cloudwatch.log_destinations":re}:{}};const ne=r.create({headers:{Authorization:"Bearer "+B.getConfig().token},timeout:B.getConfig().sendTimeout,httpAgent:new p.Agent({keepAlive:!0}),httpsAgent:new i.Agent({keepAlive:!0})});async function postBatch(e){T.debugLog(`[QUEUE] Posting batch to ${B.getConfig().traceCollectorURL}...`);const t=r.CancelToken.source(),a=setTimeout(()=>{t.cancel("Timeout sending batch!")},B.getConfig().sendTimeout);return ne.post(B.getConfig().traceCollectorURL,e,{cancelToken:t.token}).then(e=>(clearTimeout(a),T.debugLog("[QUEUE] Batch posted!"),e)).catch(e=>(clearTimeout(a),e.config&&e.config.data?T.debugLog("[QUEUE] Error sending trace. Batch size: "+e.config.data.length):T.debugLog("[QUEUE] Error sending trace. Error: "+e),T.debugLog("[QUEUE] "+(e?e.stack:e)),e))}class se extends o.EventEmitter{constructor(){super(),this.batchSender=postBatch,this.initQueue()}updateConfig(){this.maxBatchSizeBytes=B.getConfig().maxBatchSizeBytes,this.batchSize=B.getConfig().batchSize,this.maxQueueSizeBytes=B.getConfig().maxQueueSizeBytes}initQueue(){this.updateConfig(),this.removeAllListeners(),this.flush(),this.on("traceQueued",(function(){return this.byteSizeLimitReached()?(T.debugLog(`[QUEUE] Queue Byte size reached ${this.currentByteSize} Bytes, releasing batch...`),this.emit("releaseRequest",Math.max(this.currentSize-1,1))):this.batchSizeReached()&&(T.debugLog(`[QUEUE] Queue size reached ${this.currentSize}, releasing batch... `),this.emit("releaseRequest")),this})),this.on("releaseRequest",(function(e=this.batchSize){try{const t=this.queue.splice(0,e);T.debugLog("[QUEUE] Releasing batch..."),this.subtractFromCurrentByteSize(t),this.emit("batchReleased",t)}catch(e){T.debugLog("[QUEUE] Failed releasing batch!"),T.debugLog("[QUEUE] "+e)}return this})),this.on("batchReleased",(async function(e){T.debugLog("[QUEUE] Sending batch...");const t=e.map(e=>e.json);this.batchSender(t)})),process.on("exit",(function(){this.emit("releaseRequest"),this.removeAllListeners()}))}push(e){try{if(this.currentByteSize>=this.maxQueueSizeBytes)return T.debugLog(`[QUEUE] Discardig trace, queue size reached max size of ${this.currentByteSize} Bytes`),this;const t=Date.now(),r=e,a=JSON.stringify(r),n=a.length,s={json:r,string:a,byteLength:n,timestamp:t};this.queue.push(s),this.addToCurrentByteSize([s]),T.debugLog(`[QUEUE] Trace size ${n} Bytes pushed to queue`),T.debugLog(`[QUEUE] Queue size: ${this.currentSize} traces, total size of ${this.currentByteSize} Bytes`),this.emit("traceQueued",s)}catch(e){T.debugLog("[QUEUE] Failed pushing trace to queue: "+e)}return this}addToCurrentByteSize(e){e.forEach(e=>{this.currentByteSize+=e.byteLength})}subtractFromCurrentByteSize(e){e.forEach(e=>{this.currentByteSize-=e.byteLength,this.currentByteSize=Math.max(this.currentByteSize,0)})}get currentSize(){return this.queue.length}batchSizeReached(){return this.currentSize>=this.batchSize}byteSizeLimitReached(){return this.currentByteSize>=this.maxBatchSizeBytes}flush(){this.queue=[],this.currentByteSize=0}}const oe=new se;var trace_queue_getInstance=()=>oe;var ie={isBlacklistURL:(e,t,r)=>Object.keys(t).some(a=>"function"==typeof t[a]?t[a](e,a,r):e[t[a]](a)),isBlacklistHeader:(e,t)=>!!e&&t.includes(e["user-agent"]),isStrongId:e=>q.STRONG_ID_KEYS.includes(e.toLowerCase().replace(" ","_"))},pe=createCommonjsModule((function(e){const{isStrongId:a}=ie;e.exports.getTrace=()=>{};const n=trace_queue_getInstance();e.exports.createTracer=function(){if(B.getConfig().sampleRate<=Math.random())return null;return{trace:new v.Trace(["","",[],[],q.VERSION,"node "+process.versions.node]),currRunner:null,pendingEvents:new Map,createdAt:Date.now()}};const s=r.create({timeout:B.getConfig().sendTimeout,httpAgent:new p.Agent({keepAlive:!0}),httpsAgent:new i.Agent({keepAlive:!0})});function getTrimmedMetadata(e,t){let r;return Object.keys(e).forEach(n=>{a(n)||t&&"labels"===n||(r||(r=e,r.is_trimmed=!0),delete r[n])}),r}function getTrimmedTrace(e,t){let r=e;const a=Object.assign({},t);let n=0,s=0;if(a.exceptions.length>1){const[e,t,s]=function(e){const t=e[0];return[t,e.length-1,JSON.stringify(e).length-JSON.stringify(t).length]}(a.exceptions);r-=s,n=t,a.exceptions=[e]}if(T.debugLog("Epsagon - Pre metadata trim: current trace size "+r),r>=q.MAX_TRACE_SIZE_BYTES){a.events=t.events.sort(e=>["runner","trigger"].includes(e.origin)?-1:1);for(let e=t.events.length-1;e>=0;e-=1){const t=a.events[e];let n=t.resource.metadata;if(n){const e="runner"===t.origin,a=JSON.stringify(n).length,s=getTrimmedMetadata(n,e);if(s){n=s;if(r-=a-JSON.stringify(s).length,r<q.MAX_TRACE_SIZE_BYTES)break}}}}if(T.debugLog("Epsagon - After metadata trim: current trace size "+r),r>=q.MAX_TRACE_SIZE_BYTES)for(let e=t.events.length-1;e>=0;e-=1){const t=a.events[e];if(!["runner","trigger"].includes(t.origin)&&(s+=1,a.events.splice(e,1),r-=JSON.stringify(t).length,r<q.MAX_TRACE_SIZE_BYTES))break}return T.debugLog("Epsagon - After events trim: current trace size "+r),(s||n)&&T.debugLog(`Epsagon - Trace size is larger than maximum size, ${s} events and ${n} exceptions were trimmed.`),a}function addLabelsToTrace(){const t=e.exports.getTrace();t&&Object.keys(B.getConfig().labels).forEach(e=>{const r=t.currRunner.getResource().getMetadataMap().get("labels");r&&JSON.parse(r)[e]||j.addLabelToMetadata(t.currRunner,e,B.getConfig().labels[e])})}function sendCurrentTrace(t,r){const a=r||e.exports.getTrace(),{sendOnlyErrors:n,ignoredKeys:s,removeIgnoredKeys:o}=B.getConfig();if(!a)return T.debugLog("Trace object not found for sending"),Promise.resolve();if(addLabelsToTrace(),!a.currRunner)return T.debugLog("Epsagon - no trace was sent since runner was not found."),Promise.resolve();if(j.addToMetadata(a.currRunner,ae.additionalMetadata()),ecs_addECSMetadata(a.currRunner),k8s_addK8sMetadata(a.currRunner),azure_addAzureMetadata(a.currRunner),ec2_addEC2Metadata(a.currRunner),n){if(0===a.trace.getEventList().filter(e=>e.getErrorCode()).length)return T.debugLog("Epsagon - no trace was sent since no error events found."),a.pendingEvents.clear(),Promise.resolve()}let i,p={app_name:a.trace.getAppName(),token:a.trace.getToken(),events:a.trace.getEventList().map(e=>({id:e.getId(),start_time:e.getStartTime(),resource:e.hasResource()?{name:e.getResource().getName(),type:e.getResource().getType(),operation:e.getResource().getOperation(),metadata:e.getResource().getMetadataMap().toArray().reduce((e,t)=>(e[t[0]]=t[1],e),{})}:{},origin:e.getOrigin(),duration:e.getDuration(),error_code:e.getErrorCode(),exception:e.hasException()?{type:e.getException().getType(),message:e.getException().getMessage(),traceback:e.getException().getTraceback(),time:e.getException().getTime(),additional_data:e.getException().getAdditionalDataMap().toArray().reduce((e,t)=>(e[t[0]]=t[1],e),{})}:{}})),exceptions:a.trace.getExceptionList().map(e=>({type:e.getType(),message:e.getMessage(),traceback:e.getTraceback(),time:e.getTime(),additional_data:e.getAdditionalDataMap().toArray().reduce((e,t)=>(e[t[0]]=t[1],e),{})})),version:a.trace.getVersion(),platform:a.trace.getPlatform()};p=s&&Array.isArray(s)&&s.length>0?e.exports.filterTrace(p,s,o):p;try{i=JSON.stringify(p)}catch(e){return T.printWarning("Epsagon - no trace was sent since there was an error serializing the trace. Please contact support.",e),Promise.resolve()}const c=i.length;c>=q.MAX_TRACE_SIZE_BYTES&&(p=getTrimmedTrace(c,p));const u=t(p);return a.pendingEvents.clear(),B.getConfig().sampleRate!==q.DEFAULT_SAMPLE_RATE&&(a.deleted=!0),u}e.exports.addEvent=function(t,r){const a=e.exports.getTrace();a&&(this.addPendingEvent(t,r),a.trace.addEvent(t))},e.exports.addPendingEvent=function(t,r){const a=e.exports.getTrace();a&&T.isPromise(r)&&a.pendingEvents.set(t,T.makeQueryablePromise(r.catch(t=>{e.exports.addException(t)})))},e.exports.addException=function(t,r){const a=t||new Error,n=new E.Exception([a.name,a.message,a.stack,T.createTimestamp()]);"object"==typeof r&&Object.keys(r).forEach(e=>{void 0===r[e]?n.getAdditionalDataMap().set(e,"undefined"):n.getAdditionalDataMap().set(e,r[e])});const s=e.exports.getTrace();s&&s.trace.addException(n)},e.exports.initTrace=function(e){try{if(!T.isLambdaEnv){const t=ecs_hasECSMetadata();t&&ecs_loadECSMetadata(t).catch(e=>T.debugLog(e)),k8s_hasK8sMetadata()&&k8s_loadK8sMetadata(),azure_loadAzureMetadata(t=>{B.setConfig(Object.assign(t,e))}),ec2_loadEC2Metadata().catch(e=>T.debugLog(e))}}catch(e){T.debugLog("Could not extract container env data")}B.setConfig(e),n.updateConfig()},e.exports.addRunner=function(t,r){const a=e.exports.getTrace();a&&(a.trace.addEvent(t,r),a.currRunner=t)},e.exports.restart=function(){const t=e.exports.getTrace();t&&(t.disabled=!1,t.trace.clearExceptionList(),t.trace.clearEventList(),t.trace.setAppName(B.getConfig().appName),t.trace.setToken(B.getConfig().token))},e.exports.filterTrace=function(e,t,r){function isObject(e){return"object"==typeof e&&null!==e}const isString=e=>"string"==typeof e;function isNotIgnored(e){for(let r=0;r<t.length;r+=1){const a=t[r];if("string"==typeof a&&a===B.processIgnoredKey(e))return!1;if(a instanceof RegExp&&a.test(e))return!1}return!0}function filterObject(e){if(!isObject(e))return e;const a=Object.keys(e).filter(isNotIgnored),n=Object.keys(e).filter(e=>!isNotIgnored(e)),s=a.filter(t=>!isObject(e[t])&&!isString(e[t])),o=a.filter(t=>isObject(e[t])).map(t=>({[t]:filterObject(e[t])}));return a.forEach(r=>{var a,n;if(n=e[r],isString(n)&&n.length>1&&["[","{"].includes(n[0])&&(a=e[r],t.some(e=>!("string"!=typeof e||!B.processIgnoredKey(a).includes(e))||!!(e instanceof RegExp&&e.test(a)))))try{const t=JSON.parse(e[r]);t&&isObject(t)?o.push({[r]:filterObject(t)}):s.push(r)}catch(e){s.push(r)}else s.push(r)}),Object.assign({},!r&&n.reduce((e,t)=>Object.assign({},e,{[t]:"****"}),{}),s.reduce((t,r)=>Object.assign({},t,{[r]:e[r]}),{}),o.reduce((e,t)=>Object.assign({},e,t),{}))}T.debugLog("Trace was filtered with ignored keys");const a=e.events.map(e=>{if(!(e&&e.resource&&e.resource.metadata))return e;const t=Object.assign({},e);return t.resource.metadata=filterObject(e.resource.metadata),t});return Object.assign({},e,{events:a})},e.exports.postTrace=function(e){T.debugLog("Posting trace to "+B.getConfig().traceCollectorURL),T.debugLog("trace: "+JSON.stringify(e,null,2));const t=r.CancelToken.source(),a=setTimeout(()=>{t.cancel("timeout sending trace")},B.getConfig().sendTimeout);return s.post(B.getConfig().traceCollectorURL,e,{headers:{Authorization:"Bearer "+B.getConfig().token},timeout:B.getConfig().sendTimeout,cancelToken:t.token}).then(e=>(clearTimeout(a),T.debugLog("Trace posted!"),e)).catch(e=>(clearTimeout(a),e.config&&e.config.data?T.debugLog("Error sending trace. Trace size: "+e.config.data.length):T.debugLog("Error sending trace. Error: "+e),T.debugLog(""+(e?e.stack:e)),e))},e.exports.sendTrace=function(t,r){const a=r||e.exports.getTrace();return!a||a&&a.disabled?(T.debugLog("Trace object not found or disabled"),Promise.resolve()):B.getConfig().isEpsagonDisabled?(a.pendingEvents.clear(),Promise.resolve()):(addLabelsToTrace(),T.debugLog("Sending trace async..."),Promise.all(a.pendingEvents.values()).then(()=>(t(),B.getConfig().sendBatch?sendCurrentTrace(e=>n.push(e),a):sendCurrentTrace(t=>e.exports.postTrace(t),a))))},e.exports.sendTraceSync=function(){const r=e.exports.getTrace();return!r||r&&r.disabled?Promise.resolve():B.getConfig().isEpsagonDisabled?(r.pendingEvents.clear(),Promise.resolve()):(T.debugLog("Sending trace sync"),r.pendingEvents.forEach((e,r)=>{e.isPending()&&(r.getId()||r.setId(t()),r.getErrorCode()===b.ErrorCode.OK&&j.addToMetadata(r,{premature_exit:!0}),0===r.getDuration()&&r.setDuration(T.createDurationTimestamp(1e3*r.getStartTime())))}),sendCurrentTrace(t=>e.exports.postTrace(t)))},e.exports.label=function(t,r){const a=e.exports.getTrace();if(!a||!a.currRunner)return void T.debugLog("Failed to label without an active tracer");const n={[t]:r},s=T.flatten(n);Object.keys(s).forEach(e=>{j.addLabelToMetadata(a.currRunner,e,s[e])})},e.exports.setError=function(t){const r=e.exports.getTrace();r&&r.currRunner?j.setException(r.currRunner,t):T.debugLog("Failed to setError without an active tracer")},e.exports.setWarning=function(t){const r=e.exports.getTrace();r&&r.currRunner?j.setException(r.currRunner,t,!0,!0):T.debugLog("Failed to setWarning without an active tracer")},e.exports.getTraceUrl=function(){const t=e.exports.getTrace();if(!t||!t.currRunner)return T.debugLog("Failed to get trace URL without an active tracer"),"";const r=t.currRunner.getResource();return"lambda"!==r.getType()?q.traceUrl(e.exports.getTraceId(),parseInt(t.currRunner.getStartTime(),10)):q.lambdaTraceUrl(r.getMetadataMap().get("aws_account"),r.getMetadataMap().get("region"),r.getName(),t.currRunner.getId(),parseInt(t.currRunner.getStartTime(),10))},e.exports.disable=function(){const t=e.exports.getTrace();t?t.disabled=!0:T.debugLog("Failed to disabled without an active tracer")},e.exports.enable=function(){const t=e.exports.getTrace();t?t.disabled=!1:T.debugLog("Failed to enable without an active tracer")},e.exports.getTrimmedTrace=getTrimmedTrace,e.exports.isLoggingTracingEnabled=function(){return B.getConfig().loggingTracingEnabled},e.exports.getTraceId=function(){const t=e.exports.getTrace();return t&&t.currRunner&&t.currRunner.hasResource()?t.currRunner.getResource().getMetadataMap().get("trace_id"):null},e.exports.addLoggingTracingEnabledMetadata=function(){if(B.getConfig().loggingTracingEnabled){const t=e.exports.getTrace();t&&t.currRunner&&(T.debugLog("Setting logging_tracing_enabled"),j.addToMetadata(t.currRunner,{logging_tracing_enabled:!0}))}}}));pe.getTrace,pe.createTracer,pe.addEvent,pe.addPendingEvent,pe.addException,pe.initTrace,pe.addRunner,pe.restart,pe.filterTrace,pe.postTrace,pe.sendTrace,pe.sendTraceSync,pe.label,pe.setError,pe.setWarning,pe.getTraceUrl,pe.disable,pe.enable,pe.getTrimmedTrace,pe.isLoggingTracingEnabled,pe.getTraceId,pe.addLoggingTracingEnabledMetadata;let ce=null;var trace_object_get=()=>(ce&&!ce.deleted||(ce=pe.createTracer()),ce);var ue={getSNSTrigger:function(e){let t=null;return e.some(e=>{try{let r=null;if("Body"in e)r=JSON.parse(e.Body);else{if(!("body"in e))return!0;r=JSON.parse(e.body)}if("Type"in r&&"MessageId"in r&&"TopicArn"in r&&"Message"in r&&"Timestamp"in r)return t=r,!0}catch(e){}return!0}),t}};JSON.sortify=u;const de=Y("aws-sdk/clients/dynamodb");const le={s3:function(e,t){const r=t.getResource();t.setId(e.Records[0].responseElements["x-amz-request-id"]),r.setName(e.Records[0].s3.bucket.name),r.setOperation(e.Records[0].eventName),j.addToMetadata(t,{region:""+e.Records[0].awsRegion,request_parameters:JSON.stringify(e.Records[0].requestParameters),user_identity:JSON.stringify(e.Records[0].userIdentity),object_key:""+e.Records[0].s3.object.key,object_size:""+e.Records[0].s3.object.size,object_etag:""+e.Records[0].s3.object.eTag,"x-amz-request-id":""+e.Records[0].responseElements["x-amz-request-id"]})},json:function(e,r,a){const n=r.getResource();r.setId("trigger-"+t()),n.setName("trigger-"+a.functionName),n.setOperation("Event"),j.addToMetadata(r,{},{data:e})},kinesis:function(e,t){const r=t.getResource();t.setId(e.Records[0].eventID),r.setName(e.Records[0].eventSourceARN.split("/").pop()),r.setOperation(e.Records[0].eventName.replace("aws:kinesis:","")),j.addToMetadata(t,{region:e.Records[0].awsRegion,invoke_identity:e.Records[0].invokeIdentityArn,sequence_number:e.Records[0].kinesis.sequenceNumber,partition_key:e.Records[0].kinesis.partitionKey,total_record_count:e.Records.length})},events:function(e,t){const r=t.getResource();t.setId(e.id);let a="CloudWatch Events";"string"==typeof e.resources[0]&&(a=e.resources[0].split("/").pop()),r.setName(a),r.setOperation(e["detail-type"]),j.addToMetadata(t,{region:e.region,detail:JSON.stringify(e.detail),account:e.account})},sns:function(e,t){const r=t.getResource();t.setId(e.Records[0].Sns.MessageId),r.setName(e.Records[0].EventSubscriptionArn.split(":").slice(-2)[0]),r.setOperation(e.Records[0].Sns.Type),j.addToMetadata(t,{"Notification Subject":e.Records[0].Sns.Subject},{"Notification Message":e.Records[0].Sns.Message,"Notification Message Attributes":e.Records[0].Sns.MessageAttributes})},sqs:function(e,t){const r=t.getResource();t.setId(e.Records[0].messageId),r.setName(e.Records[0].eventSourceARN.split(":").slice(-1)[0]),r.setOperation("ReceiveMessage");const a=e.Records[0].body||"{}";j.addToMetadata(t,{record:e.Records.map(e=>{const t={"MD5 Of Message Body":e.md5OfBody,"Message ID":e.messageId};return B.getConfig().metadataOnly||(t["Message Body"]=T.truncateMessage(e.body||"{}",1024),t.Attributes=e.attributes,t["Message Attributes"]=e.messageAttributes),t}),total_record_count:e.Records.length});try{const e=JSON.parse(a);e.input&&e.input.Epsagon&&j.addToMetadata(t,{steps_dict:e.input.Epsagon})}catch(e){T.debugLog("Could not parse SQS message body: "+a)}const n=ue.getSNSTrigger(e.Records);null!=n&&j.addToMetadata(t,{"SNS Trigger":n})},api_gateway:function(e,t){const r=t.getResource();t.setId(e.requestContext.requestId),r.setName(e.headers.Host||e.requestContext.apiId),r.setOperation(e.httpMethod),j.addToMetadata(t,{stage:e.requestContext.stage,query_string_parameters:e.queryStringParameters,path_parameters:e.pathParameters,path:e.resource},{body:e.body,headers:e.headers,requestContext:e.requestContext})},api_gateway_no_proxy:function(e,t){const r=t.getResource();t.setId(e.context["request-id"]),r.setName(e.params.header.Host||e.context["api-id"]),r.setOperation(e.context["http-method"]),j.addToMetadata(t,{stage:e.context.stage,query_string_parameters:e.params.querystring,path_parameters:e.params.path,path:e.context["resource-path"]},{body:e["body-json"],headers:e.params.header})},api_gateway_websocket:function(e,t){const r=t.getResource();t.setId(e.requestContext.requestId),r.setName(e.requestContext.domainName),r.setOperation(e.requestContext.eventType||"CONNECT"),j.addToMetadata(t,{stage:e.requestContext.stage,route_key:e.requestContext.routeKey,message_id:e.requestContext.messageId,connection_id:e.requestContext.connectionId,request_id:e.requestContext.requestId,message_direction:e.requestContext.messageDirection},{body:e.body})},api_gateway_http2:function(e,t){const r=t.getResource();t.setId(e.requestContext.requestId),r.setName(e.headers.Host||e.requestContext.domainName),r.setOperation(e.requestContext.http.method),j.addToMetadata(t,{stage:e.requestContext.stage,query_string_parameters:e.queryStringParameters,path_parameters:e.pathParameters,path:e.requestContext.http.path,"aws.api_gateway.api_id":e.requestContext.apiId},{body:e.body,headers:e.headers,requestContext:e.requestContext})},dynamodb:function(e,t){const r=t.getResource(),a=e.Records[0];let n="";if(de){const e="REMOVE"===a.eventName?de.Converter.unmarshall(a.dynamodb.Keys):de.Converter.unmarshall(a.dynamodb.NewImage);n=c(JSON.sortify(e))}t.setId(a.eventID),r.setName(a.eventSourceARN.split("/")[1]),r.setOperation(a.eventName),j.addToMetadata(t,{region:a.awsRegion,sequence_number:a.dynamodb.SequenceNumber,item_hash:n,total_record_count:e.Records.length},{data:JSON.stringify(e.Records)})},elastic_load_balancer:function(e,r){const a=r.getResource();r.setId("elb-"+t()),a.setName(e.headers.host),a.setOperation(e.httpMethod),j.addToMetadata(r,{query_string_parameters:JSON.stringify(e.queryStringParameters),target_group_arn:e.requestContext.elb.targetGroupArn,path:e.path},{body:JSON.stringify(e.body),headers:JSON.stringify(e.headers)})},cognito:function(e,r){const a=r.getResource();r.setId("cognito-"+t()),a.setName(e.userPoolId),a.setOperation(e.triggerSource),j.addToMetadata(r,{username:e.userName,region:e.region},{caller_context:e.callerContext,request:e.request,response:e.response})}};var aws_lambda_createFromEvent=function(e,t){let r="json";e&&("Records"in e?("EventSource"in e.Records[0]&&(r=e.Records[0].EventSource.split(":").pop()),"eventSource"in e.Records[0]&&(r=e.Records[0].eventSource.split(":").pop())):"source"in e&&"detail-type"in e&&"detail"in e?r="events":"source"in e&&e.source?r=e.source.split(".").pop():"requestContext"in e&&"elb"in e.requestContext?r="elastic_load_balancer":"httpMethod"in e?r="api_gateway":"context"in e&&"http-method"in e.context?r="api_gateway_no_proxy":"dynamodb"in e?r="dynamodb":"userPoolId"in e?r="cognito":"requestContext"in e&&"apiId"in e.requestContext&&"http"in e.requestContext?r="api_gateway_http2":"requestContext"in e&&"apiId"in e.requestContext&&(r="api_gateway_websocket"));const a=new y.Resource,n=new y.Event;return n.setResource(a),le[r](e,n,t),function(e,t){e.setStartTime(T.createTimestamp()),e.setDuration(T.createTimestampFromTime(0)),e.setOrigin("trigger"),e.getResource().setType(t),e.setErrorCode(b.ErrorCode.OK)}(n,r),n};var ge={createRunner:function(e,r="lambda"){const a=new y.Resource([e.functionName,r,"invoke",{}]),n=new y.Event(["id"===e.awsRequestId?"local-"+t():e.awsRequestId,0,null,"runner",0,b.ErrorCode.OK]);n.setResource(a);const s=(e.invokedFunctionArn||"").split(":"),o=s.length>4?s[4]:"";return j.addToMetadata(n,{log_stream_name:""+e.logStreamName,log_group_name:""+e.logGroupName,function_version:""+e.functionVersion,aws_account:o,cold_start:""+q.COLD_START,memory:""+e.memoryLimitInMB,region:q.REGION}),8===s.length&&j.addToMetadata(n,{function_alias:s[7]}),q.COLD_START=!1,n}};const{getConfig:fe}=B,{STEP_ID_NAME:he,MAX_VALUE_CHARS:_e,EPSAGON_EVENT_ID_KEY:me}=q,Ee=parseInt(process.env.EPSAGON_LAMBDA_TIMEOUT_THRESHOLD_MS||200,10),be=Symbol("epsagonWrapped");function propagateEpsagonId(e,t){return process.env.EPSAGON_PROPAGATE_LAMBDA_ID&&t&&!Array.isArray(t)&&"object"==typeof t&&(t[me]=e.getId(),j.addToMetadata(e,{propagation_enabled:!0})),t}function baseLambdaWrapper(e,t="lambda",r=!1,a=null){return pe.getTrace=trace_object_get,(n,s,o)=>{let i,p;pe.restart();let c=!1,u=!1;try{i=ge.createRunner(s,t),pe.addRunner(i)}catch(t){return(null===a?e:a)(n,s,o)}try{const e=aws_lambda_createFromEvent(n,s);pe.addEvent(e)}catch(e){T.debugLog(`Error parsing trigger: ${e.stack}, Event: ${JSON.stringify(n)}`)}const d=Date.now(),runnerSendUpdateHandler=()=>{i.setDuration(T.createDurationTimestamp(d))},l=process._events.beforeExit;process._events.beforeExit=()=>{pe.sendTrace(runnerSendUpdateHandler).then(()=>{process._events.beforeExit=l})};const handleUserExecutionDone=(e,t,r)=>{if(clearTimeout(p),c||u)return Promise.resolve();if(u=!0,e){let t=e;if(!e.name){let r;try{r="string"==typeof e?e:JSON.stringify(e)}catch(e){r=""}t={name:"LambdaExecutionError",message:r}}i.getException()||(T.debugLog("Setting exception from handleUserExecutionDone"),j.setException(i,t,!1))}const{statusCode:a}=t||{};if(a&&j.addToMetadata(i,{status_code:a}),null===e&&!fe().metadataOnly){let e;try{e=JSON.stringify(void 0===t?null:t)}catch(t){e="Unable to stringify response body as json: "+t.message}j.addToMetadata(i,{return_value:e.substring(0,_e)})}return process._events.beforeExit=l,c=!0,!r&&s.callbackWaitsForEmptyEventLoop?pe.sendTrace(runnerSendUpdateHandler):(runnerSendUpdateHandler(),pe.sendTraceSync())};!function(e,t){const r=process._events.uncaughtException;process._events.uncaughtException=(a,n)=>{process._events.uncaughtException=r,j.setException(t,a,!1),e(a,null,!0).then(()=>{r&&"function"==typeof r&&r(a,n)})};const a=process._events.unhandledRejection;process._events.unhandledRejection=(r,n)=>{process._events.unhandledRejection=a;const s=Error(r);j.setException(t,s,!1),e(s,null,!0).then(()=>{a&&"function"==typeof a&&a(r,n)})}}(handleUserExecutionDone,i);let g=Promise.resolve();const wrappedCallback=(e,t)=>{T.debugLog("wrapped callback called",e,t),t=propagateEpsagonId(i,t),u?T.debugLog("not calling callback since it was already called"):g=new Promise(r=>{T.debugLog("handling execution done before calling callback"),handleUserExecutionDone(e,t).then(()=>{T.debugLog("calling User's callback"),o(e,t),r()})})};let f=Promise.resolve();const h=Object.assign({},s,{succeed:e=>{T.debugLog("wrapped succeed called"),u?T.debugLog("not calling succeed, callback was already called"):f=new Promise(t=>{handleUserExecutionDone(null,e,!0).then(()=>g).then(()=>s.succeed(e)).then(()=>t())})},fail:e=>{T.debugLog("wrapped fail called"),u?T.debugLog("not calling fail, callback was already called"):f=new Promise(t=>{handleUserExecutionDone(e,null,!0).then(()=>g).then(()=>s.fail(e)).then(()=>t())})},done:(e,t)=>{T.debugLog("wrapped done called"),u?T.debugLog("not calling done, callback was already called"):f=new Promise(r=>{handleUserExecutionDone(e,t,!0).then(()=>g).then(()=>s.done(e,t)).then(()=>r())})}});Object.defineProperty(h,"callbackWaitsForEmptyEventLoop",{set:e=>{s.callbackWaitsForEmptyEventLoop=e},get:()=>s.callbackWaitsForEmptyEventLoop});try{p=setTimeout(()=>{T.debugLog("In timeout handler"),c=!0,j.markAsTimeout(i),runnerSendUpdateHandler(),pe.sendTraceSync()},h.getRemainingTimeInMillis()-Ee),i.setStartTime(T.createTimestampFromTime(d));let t=r?e(n,h,wrappedCallback,i):e(n,h,wrappedCallback);if(t&&"function"==typeof t.then){let e,r;t=t.then(e=>(T.debugLog("user promise resolved (in then)"),e=propagateEpsagonId(i,e),r=e,handleUserExecutionDone(null,e,!0))).catch(t=>(T.debugLog("user promise rejected (in catch)"),e=t,handleUserExecutionDone(t,null,!0))).then(()=>g).then(()=>f).then(()=>{if(e)throw e;return r})}return t}catch(e){h.fail(e)}}}function extractAndAppendStepData(e,r,a){let n=null;return"object"==typeof a&&(n||(e&&e[he]?(n=Object.assign({},e[he]),n.step_num+=1):n={id:t(),step_num:0}),a[he]=n,j.addToMetadata(r,{steps_dict:n})),T.debugLog("Step function response update attempt"),T.debugLog("Updated response: "+d.inspect(a,{showHidden:!1,depth:null})),a}function createStepIdAddWrapper(e){return(t,r,a,n)=>{let s=e(t,r,(e,r)=>(e||extractAndAppendStepData(t,n,r),a(e,r)));return s&&"function"==typeof s.then&&(T.debugLog("Step function response is async"),s=s.then(e=>extractAndAppendStepData(t,n,e))),s}}var lambda_lambdaWrapper=function(e){if(e[be])return e;const t=baseLambdaWrapper(e);return Object.defineProperty(t,be,{value:!0,writable:!1}),t},lambda_stepLambdaWrapper=function(e){if(e[be])return e;const t=baseLambdaWrapper(createStepIdAddWrapper(e),"step_function_lambda",!0,e);return Object.defineProperty(t,be,{value:!0,writable:!1}),t};const ye=function(){const createErrorHandler=e=>(t,r)=>{r.fail(e)},createErrorHandlerWithMessage=(e,t)=>(r,a)=>{console.log(e),a.fail(t)},e=process.env.EPSAGON_HANDLER;if(!e)return createErrorHandler(new Error("invalid EPSAGON_HANDLER "+e));const t=e.split(".");if(2!==t.length)return createErrorHandler(new Error("Bad handler "+e));const r=t[0],a=t[1];try{const e=process.env.LAMBDA_TASK_ROOT,t=Y(`${e}/${r}`);if(!t)return createErrorHandler(Y.lastError());const n=t[a];return n||createErrorHandler(new Error(`Handler '${a}' missing on module '${r}'`))}catch(e){return"MODULE_NOT_FOUND"===e.code?createErrorHandlerWithMessage(`Unable to import module '${r}'`,e):e instanceof SyntaxError?createErrorHandlerWithMessage(`Syntax error in module '${r}'`,e):createErrorHandlerWithMessage("module initialization error",e)}}();var ve={wrapper:B.getConfig().isEpsagonDisabled?ye:lambda_lambdaWrapper(ye)};const $e=Symbol("epsagonWrapped"),Te=new Map;function getTracer(){const e=process.env.__OW_ACTIVATION_ID;return e?Te.get(e):null}function unregisterTracer(){const e=process.env.__OW_ACTIVATION_ID;e&&Te.delete(e)}function baseOpenWhiskWrapper(e,t){return pe.getTrace=getTracer,r=>{let a;t&&"object"==typeof t&&(t.token?pe.initTrace(t):t.token_param&&r&&pe.initTrace(Object.assign({token:r[t.token_param]},t))),function(){const e=process.env.__OW_ACTIVATION_ID;e&&Te.set(e,pe.createTracer())}(),pe.restart();try{a=function(e,t){const r=new y.Resource([e,"openwhisk_action","invoke",{}]),a=new y.Event([process.env.__OW_ACTIVATION_ID,0,null,"runner",0,b.ErrorCode.OK]);return a.setResource(r),j.addToMetadata(a,{activation_id:process.env.__OW_ACTIVATION_ID,transaction_id:process.env.__OW_TRANSACTION_ID,api_host:process.env.__OW_API_HOST,namespace:process.env.__OW_NAMESPACE,params:t}),a}(process.env.__OW_ACTION_NAME,r)}catch(t){return e(r)}pe.addRunner(a);const n=Date.now(),runnerSendUpdateHandler=()=>{a.setDuration(T.createDurationTimestamp(n))};try{a.setStartTime(T.createTimestampFromTime(n));const t=e(r);return t&&"function"==typeof t.then?t.catch(e=>{throw j.setException(a,e),runnerSendUpdateHandler(),e}).finally(()=>pe.sendTrace(runnerSendUpdateHandler).catch(()=>{}).finally(unregisterTracer)):(pe.sendTrace(runnerSendUpdateHandler).catch(()=>{}).finally(unregisterTracer),t)}catch(e){throw j.setException(a,e),runnerSendUpdateHandler(),pe.sendTraceSync().finally(unregisterTracer),e}}}var openwhisk_openWhiskWrapper=function(e,t){if(e[$e])return e;const r=baseOpenWhiskWrapper(e,t);return Object.defineProperty(r,$e,{value:!0,writable:!1}),r};const{getConfig:xe}=B;var node_nodeWrapper=function(e){return pe.getTrace=trace_object_get,(...r)=>{let a;pe.restart();try{a=function(e,r){const a=new y.Resource([e.name||"handler","node_function","invoke",{}]),n=new y.Event([t(),0,null,"runner",0,b.ErrorCode.OK]);return n.setResource(a),j.addToMetadata(n,{args_length:r.length},{arguments:r}),j.createTraceIdMetadata(n),q.COLD_START=!1,n}(e,r)}catch(t){return e(...r)}pe.addRunner(a);const n=Date.now(),runnerSendUpdateHandler=()=>{a.setDuration(T.createDurationTimestamp(n))};try{a.setStartTime(T.createTimestampFromTime(n));const t=e(...r);!function(e){process.env.EPSAGON_STEPS_ID&&j.addToMetadata(e,{steps_dict:{id:process.env.EPSAGON_STEPS_ID,step_num:process.env.EPSAGON_STEPS_NUM||0}})}(a);const s=Promise.resolve(t).then(e=>{if(!xe().metadataOnly){let t;try{t=JSON.stringify(void 0===e?null:e)}catch(e){t="Unable to stringify response body as json: "+e.message}j.addToMetadata(a,{return_value:t.substring(0,q.MAX_VALUE_CHARS)})}pe.sendTrace(runnerSendUpdateHandler)}).catch(e=>{j.setException(a,e),runnerSendUpdateHandler(),pe.sendTraceSync().then(()=>{throw e})});return t&&"function"==typeof t.then?s:t}catch(e){throw j.setException(a,e),runnerSendUpdateHandler(),pe.sendTraceSync(),e}}};var Se={createRunner:function(){const e=new y.Resource([process.env.AWS_BATCH_JOB_ID,"batch","invoke",{}]),t=new y.Event([process.env.AWS_BATCH_JOB_ID,0,null,"runner",0,b.ErrorCode.OK]);t.setResource(e),j.addToMetadata(t,{"Job ID":process.env.AWS_BATCH_JOB_ID,"Job Queue Name":process.env.AWS_BATCH_JQ_NAME,"Compute Environment Name":process.env.AWS_BATCH_CE_NAME,"Job Attempt":process.env.AWS_BATCH_JOB_ATTEMPT},{Hostname:process.env.HOSTNAME,Home:process.env.HOME,Path:process.env.PATH,Arguments:JSON.stringify(process.argv)}),j.createTraceIdMetadata(t);const a=r.get("http://169.254.169.254/latest/dynamic/instance-identity/document",{timeout:100}).then(e=>{T.debugLog("Got Batch response "+e.data);try{const r=JSON.parse(e.data);j.addToMetadata(t,{Region:r.region})}catch(e){T.debugLog("Could not parse Batch env data "+e.toString())}}).catch(e=>{throw pe.addException(e),e});return{runner:t,runnerPromise:a}}},batch_wrapBatchJob=function(){pe.getTrace=trace_object_get,pe.restart();try{const{runner:e,runnerPromise:t}=Se.createRunner();pe.addRunner(e,t);const r=Date.now(),runnerSendUpdateHandler=()=>{e.setDuration(T.createDurationTimestamp(r))};e.setStartTime(T.createTimestampFromTime(r)),process.on("uncaughtException",t=>{j.setException(e,t)}),process.once("beforeExit",()=>{pe.sendTrace(runnerSendUpdateHandler)});const processExitWrapper=e=>function(t){runnerSendUpdateHandler(),pe.sendTraceSync(),e.apply(this,[t])};l.wrap(process,"exit",processExitWrapper)}catch(e){T.debugLog("failed to create Batch runner",e),pe.addException(e)}};const{MAX_HTTP_VALUE_SIZE:Ae}=q,Me={br:g.brotliDecompressSync,brotli:g.brotliDecompressSync,gzip:g.gunzipSync,deflate:g.deflateSync};function UUIDToHex(e){const t=Buffer.alloc(16);return f.parse(e,t),t.toString("hex")}var Re={isURLIgnoredByUser:function(e){return B.getConfig().urlPatternsToIgnore.some(t=>e.includes(t))},resolveHttpPromise:function(e,t,r){e.setDuration(T.createDurationTimestamp(r)),t()},USER_AGENTS_BLACKLIST:["openwhisk-client-js"],URL_BLACKLIST:{"tc.epsagon.com":"endsWith","oauth2.googleapis.com":"endsWith","amazonaws.com":(e,t)=>(e.endsWith(t)||e.endsWith(t+":443"))&&-1===e.indexOf(".execute-api.")&&-1===e.indexOf(".es.")&&-1===e.indexOf(".elb.")&&-1===e.indexOf(".appsync-api."),"blob.core.windows.net":"endsWith","documents.azure.com":"endsWith","127.0.0.1":(e,t,r)=>e===t&&r.startsWith("/2018-06-01/runtime/invocation/"),"169.254.169.254":"startsWith"},generateEpsagonTraceId:function(){return`${UUIDToHex(t())}:${UUIDToHex(t()).slice(16)}:${UUIDToHex(t()).slice(16)}:1`},updateAPIGateway:function(e,t){e&&"x-amzn-requestid"in e&&(t.getResource().setType("api_gateway"),j.addToMetadata(t,{request_trace_id:e["x-amzn-requestid"]}))},setJsonPayload:function(e,t,r,a){try{let n=r;if(B.getConfig().decodeHTTP&&Me[a])try{n=Me[a](r)}catch(e){T.debugLog(`Could decode ${t} with ${a} in http`)}const s=n;try{JSON.parse(s),j.addToMetadata(e,{},{[t]:s.toString()})}catch(r){T.debugLog(`Could not parse JSON ${t} in http`),j.addToMetadata(e,{},{[t]:n.toString("utf-8")})}}catch(a){T.debugLog(`Could not decode data and parse JSON ${t} in http`),j.addToMetadata(e,{},{[t]:r})}},addChunk:function(e,t){if(e){t.reduce((e,t)=>t.length+e,0)+e.length<=Ae&&t.push("string"==typeof e?Buffer.from(e):e)}}},Ce=createCommonjsModule((function(e){const{LAMBDA_DEFAULT_NODE_MODULES_PATH:t}=q;let r;const getAllNodeModulesPaths=(e,t=[])=>{let r=t;return n.readdirSync(e).forEach(t=>{n.statSync(`${e}/${t}`).isDirectory()&&("node_modules"===t?r.push(h.join(e,t)):r=getAllNodeModulesPaths(`${e}/${t}`,r))}),r};e.exports.getModules=function(e){const a=[];if("function"!=typeof require.resolve.paths){T.debugLog("require.resolve.paths is not a function");const t=Y(e);return t&&a.push(t),a}const n=require.resolve.paths(e);if(process.env.EPSAGON_ADD_NODE_PATH&&n.push(...process.env.EPSAGON_ADD_NODE_PATH.split(":").map(e=>e.trim())),process.env.EPSAGON_AUTO_ADD_NODE_PATHS&&"TRUE"===process.env.EPSAGON_AUTO_ADD_NODE_PATHS.toUpperCase()){const e=h.dirname(require.main.filename);r||(r=getAllNodeModulesPaths(e)),T.debugLog("Found the following paths",r),r.forEach(e=>{n.includes(e)||n.push(e)})}return T.isLambdaEnv&&!n.includes(t)&&n.push(t),n.forEach(t=>{const r=Y(`${t}/${e}`);r&&(T.debugLog("Loaded module",e,t),a.push(r))}),a};const a=[];e.exports.patchModule=function(t,r,n,s=(e=>e)){T.debugLog("patching module:",t);const o=e.exports.getModules(t);T.debugLog("found module copies:",o.length),o.forEach(e=>{const o=s(e);a.push({id:t,methodName:r,module:o}),l.wrap(o,r,n)}),T.debugLog("done patching module:",t)},e.exports.patchSingle=function(e,t,r){a.push({id:t,methodName:t,module:e}),l.wrap(e,t,r)},e.exports.unpatchModules=function(){console.log("unpatching all modules"),a.forEach(e=>{console.log(`unpatching ${e.methodName} from ${e.id}`),l.unwrap(e.module,e.methodName)}),console.log("finished unpatching")}}));Ce.getModules,Ce.patchModule,Ce.patchSingle,Ce.unpatchModules;JSON.sortify=u;const{STEP_ID_NAME:Oe}=q,we=Y("aws-sdk/clients/dynamodb"),Ne={generateItemHash(e){const t=we.Converter.unmarshall(e);return c(JSON.sortify(t))},requestHandler(e,t){const r=e.params||{},a=t.getResource(),{operation:n}=e;switch(a.setName(r.TableName||"DynamoDBEngine"),n){case"deleteItem":j.addToMetadata(t,{item_hash:this.generateItemHash(r.Key)});case"getItem":j.addToMetadata(t,{},{Key:r.Key});break;case"putItem":j.addToMetadata(t,{item_hash:this.generateItemHash(r.Item)},{Item:JSON.stringify(r.Item)});break;case"updateItem":j.addToMetadata(t,{Key:r.Key},{"Update Expression":JSON.stringify(r.UpdateExpression),"Expression Attribute Names":JSON.stringify(r.ExpressionAttributeNames),"Expression Attribute Values":JSON.stringify(r.ExpressionAttributeValues)});break;case"query":j.addObjectToMetadata(t,"Parameters",r,["KeyConditions","QueryFilter","ExclusiveStartKey","ProjectionExpression","FilterExpression","KeyConditionExpression","ExpressionAttributeValues"]);break;case"scan":j.addObjectToMetadata(t,"Parameters",r,["ScanFilter","ExclusiveStartKey","ProjectionExpression","FilterExpression","ExpressionAttributeValues"]);break;case"batchWriteItem":{const e=Object.keys(r.RequestItems)[0];a.setName(e||r.TableName);const n=[],s=[];r.RequestItems[e].forEach(e=>{e.PutRequest&&n.push(e.PutRequest.Item),e.DeleteRequest&&s.push(e.DeleteRequest.Key)}),0!==n.length&&j.addToMetadata(t,{},{"Added Items":JSON.stringify(n)}),0!==s.length&&j.addToMetadata(t,{},{"Deleted Keys":JSON.stringify(s)});break}}},responseHandler(e,t){switch(e.request.operation){case"getItem":j.addToMetadata(t,{},{Item:JSON.stringify(e.data.Item)});break;case"updateItem":e.data.Attributes&&j.addToMetadata(t,{item_hash:this.generateItemHash(e.data.Attributes)},{});break;case"listTables":j.addToMetadata(t,{"Table Names":e.data.TableNames.join(", ")});break;case"scan":case"query":j.addObjectToMetadata(t,"Response",e.data,["Items","LastEvaluatedKey"])}}},initializeStepsDict=(e,r,a)=>{const n=(e.params||{})[r];let s;try{s=JSON.parse(n)}catch(e){s=null}s&&(s[Oe]={id:t(),step_num:-1},e.params[r]=JSON.stringify(s),j.addToMetadata(a,{steps_dict:s[Oe]}))},Le={requestHandler(e,t){const r=(e.params||{}).Entries[0]||{},{operation:a}=e,n=t.getResource();switch(n.setType("events"),a){case"putEvents":n.setName(r.EventBusName||"CloudWatch Events"),j.addToMetadata(t,{"aws.cloudwatch.detail_type":r.DetailType,"aws.cloudwatch.resources":r.Resources,"aws.cloudwatch.source":r.Source},{"aws.cloudwatch.detail":r.Detail})}},responseHandler(e,t){switch(e.request.operation){case"putEvents":j.addToMetadata(t,{"aws.cloudwatch.event_id":""+e.data.Entries[0].EventId})}}},Ie={s3:{requestHandler(e,t){const r=e.params||{},{operation:a}=e,n=t.getResource();switch(n.setName(""+r.Bucket),a){case"headObject":case"getObject":case"putObject":n.getMetadataMap().set("key",""+r.Key)}},responseHandler(e,t){const r=t.getResource();switch(e.request.operation){case"listObjects":r.getMetadataMap().set("files",e.data.Contents.map(e=>[""+e.Key,e.Size,e.Etag]).toString());break;case"putObject":r.getMetadataMap().set("etag",""+e.data.ETag.replace(/"/g,""));break;case"headObject":case"getObject":j.addToMetadata(t,{etag:""+e.data.ETag.replace(/"/g,""),file_size:""+e.data.ContentLength,last_modified:""+e.data.LastModified})}}},kinesis:{requestHandler(e,t){const r=e.params||{},{operation:a}=e;switch(t.getResource().setName(""+r.StreamName||"Kinesis"),a){case"putRecord":j.addToMetadata(t,{partition_key:""+r.PartitionKey},{data:""+r.Data});break;case"putRecords":j.addToMetadata(t,{total_record_count:""+r.Records.length},{data:JSON.stringify(r.Records)})}},responseHandler(e,t){let r="",a=0;switch(e.request.operation){case"putRecord":j.addToMetadata(t,{shard_id:""+e.data.ShardId,sequence_number:""+e.data.SequenceNumber});break;case"putRecords":e.data.FailedRecordCount&&e.data.FailedRecordCount>0&&(r=JSON.stringify(e.data.Records.map(e=>e.ErrorMessage)),a=e.data.FailedRecordCount),j.addToMetadata(t,{total_record_count:""+e.data.Records.length,failed_record_count:""+a,kinesis_error_messages:r})}}},sns:{requestHandler(e,t){const r=e.params||{},a=t.getResource(),n=r.TopicArn||r.TargetArn;a.setName(""+n.split(":").pop()||"N/A"),j.addToMetadata(t,{},{"Notification Message":""+r.Message,"Notification Message Attributes":""+JSON.stringify(r.MessageAttributes)})},responseHandler(e,t){switch(e.request.operation){case"publish":j.addToMetadata(t,{"Message ID":""+e.data.MessageId})}}},sqs:{requestHandler(e,t){const r=e.params||{},a=t.getResource();"QueueUrl"in r&&a.setName(""+r.QueueUrl.split("/").pop()),"QueueName"in r&&a.setName(r.QueueName);const n="Entries"in r?r.Entries:r;"MessageBody"in n&&j.addToMetadata(t,{},{"Message Body":n.MessageBody}),"MessageAttributes"in n&&j.addToMetadata(t,{},{"Message Attributes":n.MessageAttributes})},responseHandler(e,t){let r="",a=0;switch(e.request.operation){case"sendMessage":j.addToMetadata(t,{"Message ID":""+e.data.MessageId,"MD5 Of Message Body":""+e.data.MD5OfMessageBody});break;case"sendMessageBatch":case"deleteMessageBatch":e.data.Failed&&e.data.Failed>0&&(r=JSON.stringify(e.data.Failed.map(e=>e)),a=e.data.FailedRecordCount),j.addToMetadata(t,{successful_record_count:""+e.data.Successful.length,failed_record_count:""+a,sqs_error_messages:r});break;case"receiveMessage":{let r=0;if("Messages"in e.data&&e.data.Messages.length>0){r=e.data.Messages.length,j.addToMetadata(t,{"Message ID":""+e.data.Messages[0].MessageId,"MD5 Of Message Body":""+e.data.Messages[0].MD5OfBody});const a=ue.getSNSTrigger(e.data.Messages);null!=a&&j.addToMetadata(t,{"SNS Trigger":a})}j.addToMetadata(t,{"Number Of Messages":r});break}}}},ses:{requestHandler(e,t){const r=e.params||{};switch(e.operation){case"sendEmail":j.addToMetadata(t,{source:""+r.Source,destination:""+r.Destination.ToAddresses},{subject:""+r.Message.Subject.Data,"Message Text":""+r.Message.Body.Text.Data,"Message Html":""+r.Message.Body.Html.Data})}},responseHandler(e,t){switch(e.request.operation){case"sendEmail":j.addToMetadata(t,{message_id:""+e.data.MessageId})}}},lambda:{requestHandler(e,t){const r=e.params||{},a=t.getResource();T.debugLog("Got lambda event on function: "+r.FunctionName);const n=r.FunctionName.includes(":")?r.FunctionName.split(":").slice(-1)[0]:r.FunctionName;a.setName(n),j.addToMetadata(t,{},{payload:""+r.Payload})},responseHandler(e,t){}},dynamodb:Ne,athena:{requestHandler(e,t){const r=e.params||{};switch(e.operation){case"startQueryExecution":"QueryExecutionContext"in r&&"Database"in r.QueryExecutionContext&&j.addToMetadata(t,{Database:""+r.QueryExecutionContext.Database}),j.addToMetadata(t,{},{Query:""+r.QueryString});break;case"getQueryExecution":case"getQueryResults":case"stopQueryExecution":j.addToMetadata(t,{"Query ID":""+r.QueryExecutionId})}},responseHandler(e,t){switch(e.request.operation){case"getQueryExecution":"Status"in e.data.QueryExecution&&"State"in e.data.QueryExecution.Status&&j.addToMetadata(t,{State:""+e.data.QueryExecution.Status.State}),"ResultConfiguration"in e.data.QueryExecution&&"OutputLocation"in e.data.QueryExecution.Status&&j.addToMetadata(t,{"Result Location":""+e.data.QueryExecution.ResultConfiguration.OutputLocation}),j.addToMetadata(t,{"Query ID":""+e.data.QueryExecutionId},{Query:""+e.data.Query});break;case"getQueryResults":j.addToMetadata(t,{"Query Row Count":""+e.data.ResultSet.Rows.length});break;case"startQueryExecution":j.addToMetadata(t,{"Query ID":""+e.data.QueryExecutionId})}}},stepfunctions:{patchInput(e,t){switch(e.operation){case"startExecution":case"stopExecution":initializeStepsDict(e,"input",t);break;case"sendTaskSuccess":case"sendTaskFailure":initializeStepsDict(e,"output",t)}},requestHandler(e,t){const r=e.params,a=t.getResource();switch(e.operation){case"startExecution":a.setName(""+r.stateMachineArn.split(":").pop()),j.addToMetadata(t,{"State Machine ARN":""+r.stateMachineArn,"Execution Name":""+r.name},{Input:""+r.input})}},responseHandler(e,t){switch(e.request.operation){case"startExecution":j.addToMetadata(t,{"Execution ARN":""+e.data.executionArn,"Start Date":""+e.data.startDate})}}},batch:{requestHandler(e,t){const r=e.params||{},{operation:a}=e,n=t.getResource();switch(a){case"submitJob":{n.setName(""+r.jobName);const e={};"containerOverrides"in r&&(e["Container Overrides"]=r.containerOverrides),"parameters"in r&&(e.Parameters=r.parameters),j.addToMetadata(t,{"Job Definition":""+r.jobDefinition,"Job Queue":""+r.jobQueue},e);break}}},responseHandler(e,t){switch(e.request.operation){case"submitJob":j.addToMetadata(t,{"Job ID":""+e.data.jobId})}}},cloudwatchevents:Le,eventbridge:Le,cloudwatchlogs:{requestHandler(e,t){const r=e.params||{},{operation:a}=e,n=t.getResource();switch(n.setType("logs"),a){case"filterLogEvents":n.setName(r.logGroupName),j.addToMetadata(t,{"aws.cloudwatch.log_streams":e.logStreamNames,"aws.cloudwatch.start_time":e.startTime});break;case"getMetricData":n.setName(r.logGroupName),j.addToMetadata(t,{"aws.cloudwatch.start_time":e.startTime,"aws.cloudwatch.end_time":e.endTime})}},responseHandler(e,t){switch(e.request.operation){case"filterLogEvents":j.addToMetadata(t,{"aws.cloudwatch.events_count":e.data.events.length,"aws.cloudwatch.searched_log_streams":e.data.searchedLogStreams.length})}}},ssm:{requestHandler(e,t){const r=e.params||{},a=t.getResource(),{operation:n}=e;switch(a.setName(r.Name||"SSM"),n){case"getParameter":j.addToMetadata(t,{},{WithDecryption:r.WithDecryption})}},responseHandler(e,t){switch(e.request.operation){case"getParameter":j.addToMetadata(t,{value:(e.data.Parameter||{Value:""}).Value||""})}}}};function AWSSDKWrapper(e){return function(t){try{const r=this,{serviceIdentifier:a}=r.service.constructor.prototype;if(!(a in Ie))return e.apply(this,[t]);const n=new y.Resource(["",a,""+r.operation]),s=Date.now(),o=new y.Event(["",T.createTimestampFromTime(s),null,"aws-sdk",0,b.ErrorCode.OK]);o.setResource(n),"patchInput"in Ie[a]&&Ie[a].patchInput(this,o);const i=new Promise(e=>{r.on("send",()=>{try{Ie[a].requestHandler(r,o)}catch(e){pe.addException(e)}}).on("error",e=>{try{j.setException(o,e)}catch(e){pe.addException(e)}}).on("complete",t=>{try{o.setId(""+t.requestId),o.setDuration(T.createDurationTimestamp(s)),null!==t.data&&(o.setErrorCode(b.ErrorCode.OK),j.addToMetadata(o,{request_id:""+t.requestId,retry_attempts:""+t.retryCount,status_code:""+t.httpResponse.statusCode}),Ie[a].responseHandler(t,o)),null!==t.error&&(o.getErrorCode()!==b.ErrorCode.EXCEPTION&&o.setErrorCode(b.ErrorCode.ERROR),j.addToMetadata(o,{request_id:""+t.requestId,error_message:""+t.error.message,error_code:""+t.error.code}))}catch(e){pe.addException(e)}finally{e()}})});pe.addEvent(o,i)}catch(e){pe.addException(e)}return e.apply(this,[t])}}function wrapPromiseOnAdd(e){return function(t){const r=e.apply(this,[t]);try{Ce.patchModule("aws-sdk/global","promise",AWSSDKWrapper,e=>e.Request.prototype)}catch(e){T.debugLog("Failed to re-instrument aws-sdk's promise method",e)}return r}}var De={init(){Ce.patchModule("aws-sdk/global","send",AWSSDKWrapper,e=>e.Request.prototype),Ce.patchModule("aws-sdk/global","promise",AWSSDKWrapper,e=>e.Request.prototype),Ce.patchModule("aws-sdk/global","addPromisesToClass",wrapPromiseOnAdd,e=>e.Request)},dynamoDBEventCreator:Ne};const{dynamoDBEventCreator:Pe}=De;function DAXWrapper(e){return function(t,r,a,n){const s=new y.Resource(["","dax",""+t]),o=Date.now(),i=new y.Event(["",T.createTimestampFromTime(o),null,"amazon-dax-client",0,b.ErrorCode.OK]);i.setResource(s);try{Pe.requestHandler({params:r,operation:t},i)}catch(e){pe.addException(e)}const p=e.apply(this,[t,r,a,n]);try{const e=new Promise(e=>{p.once("error",e=>{try{j.setException(i,e)}catch(e){pe.addException(e)}if(0===p.listenerCount("error"))throw e}).on("complete",t=>{try{i.setId(""+t.requestId),i.setDuration(T.createDurationTimestamp(o)),null!==t.data&&(i.setErrorCode(b.ErrorCode.OK),j.addToMetadata(i,{request_id:""+t.requestId,retry_attempts:""+t.retryCount,status_code:""+t.httpResponse.statusCode}),Pe.responseHandler(t,i)),null!==t.error&&(i.getErrorCode()!==b.ErrorCode.EXCEPTION&&i.setErrorCode(b.ErrorCode.ERROR),j.addToMetadata(i,{request_id:""+t.requestId,error_message:""+t.error.message,error_code:""+t.error.code}))}catch(e){pe.addException(e)}finally{e()}})});pe.addEvent(i,e)}catch(e){pe.addException(e)}return p}}var ke={init(){Ce.patchModule("amazon-dax-client","_makeWriteRequestWithRetries",DAXWrapper,e=>e.prototype),Ce.patchModule("amazon-dax-client","_makeReadRequestWithRetries",DAXWrapper,e=>e.prototype)}};const{isBlacklistURL:We,isBlacklistHeader:qe}=ie,{isURLIgnoredByUser:Be,resolveHttpPromise:je,USER_AGENTS_BLACKLIST:Ue,URL_BLACKLIST:Fe,generateEpsagonTraceId:ze,updateAPIGateway:He,setJsonPayload:Ke,addChunk:Ge}=Re;function requestOnWrapper(e,t){return function(r,a,n){if("response"!==r||"skip"===n||"function"!=typeof a)return e.apply(this,[r,a]);return e.apply(this,[r,(e=>(e&&e.EPSAGON_PATCH||(e.EPSAGON_PATCH=!0,l.wrap(e,"on",e=>function(e,t){return function(r,a){return"data"!==r||"function"!=typeof a?e.apply(this,[r,a]):e.apply(this,[r,(e=>(Ge(e,t),a(e))).bind(this)])}}(e,t))),a(e))).bind(this)])}}function httpWrapper(e){return function(r,a,n){const{url:s,options:o,callback:i}=function(e,t,r){let a=e,n=t,s=r;return["string","URL"].includes(typeof a)||s||(s=t,n=e,a=void 0),"function"!=typeof n||s||(s=n,n=null),e.constructor&&"URL"===e.constructor.name&&"object"==typeof t&&!r&&(a=e,a.path=a.pathname,n=t,s=void 0),{url:a,options:n,callback:s}}(r,a,n),p=[];let c=null;try{let u=s;"string"==typeof u&&(u=_.parse(u));let d=u&&u.hostname||u&&u.host||o&&o.hostname||o&&o.host||o&&o.uri&&o.uri.hostname||"localhost";if(T.debugLog("[http] captured call "+d),i&&i.__epsagonCallback)return T.debugLog("[http] filtered patched callback "+d),e.apply(this,[r,a,n]);o.port&&!["80","443",80,443].includes(o.port)&&(d=`${d}:${o.port}`);const g=u&&u.path||o&&o.path||"/",f=u&&u.pathname||o&&o.pathname||"/",h=o&&o.headers||{};if(We(d,Fe,g)||Be(d))return T.debugLog("[http] filtered ignored hostname "+d),e.apply(this,[r,a,n]);if(qe(h,Ue))return T.debugLog("[http] filtered ignored headers"),e.apply(this,[r,a,n]);const m=ze();"TRUE"!==(process.env.EPSAGON_DISABLE_HTTP_TRACE_ID||"").toUpperCase()&&(h["epsagon-trace-id"]=m,o.headers||(o.headers=h)),o&&o.headers&&o.headers.epsagonSkipResponseData&&o.agent&&(o.agent.epsagonSkipResponseData=!0,delete o.headers.epsagonSkipResponseData);const E=o&&o.agent||o&&o._defaultAgent||void 0,v=u&&u.port||o&&o.port||o&&o.defaultPort||E&&E.defaultPort||80;let $=u&&u.protocol||443===v&&"https:"||o&&o.protocol||E&&E.protocol||"http:";$=$.slice(0,-1);const x=o&&o.body&&(o.body instanceof String||o.body instanceof Buffer)?o.body:"",S=o&&o.method||"GET",A=new y.Resource([d,"http",S]),M=Date.now(),R=new y.Event(["http-"+t(),T.createTimestampFromTime(M),null,"http",0,b.ErrorCode.OK]),C=`${$}://${d}${f}`;R.setResource(A),j.addToMetadata(R,{url:C,http_trace_id:m},{path:g,request_headers:h}),x&&(T.debugLog("Set request body="+x),j.addToMetadata(R,{},{request_body:x}));const patchedCallback=e=>{T.debugLog("[http] patched callback called for "+d);const t={};"x-openwhisk-activation-id"in e.headers&&(t.openwhisk_act_id=e.headers["x-openwhisk-activation-id"]),"x-last-activation-id"in e.headers&&(t.openwhisk_last_act_id=e.headers["x-last-activation-id"]),"x-request-id"in e.headers&&(t.request_id=e.headers["x-request-id"]),j.addToMetadata(R,{status:e.statusCode}),e.statusCode>=B.HTTP_ERR_CODE&&j.setException(R,new Error("Response code: "+e.statusCode)),j.addToMetadata(R,t,{response_headers:e.headers}),e.req&&e.req.getHeaders()&&j.addToMetadata(R,{},{request_headers:e.req.getHeaders()}),He(e.headers,R),i&&"function"==typeof i&&i(e)};patchedCallback.__epsagonCallback=!0,c=e.apply(this,function(e,t,r){return e&&t?[e,t,r]:e&&!t?[e,r]:[t,r]}(s,o,patchedCallback)),T.debugLog("[http] request sent "+d),o&&o.epsagonSkipResponseData&&!B.getConfig().disableHttpResponseBodyCapture&&l.wrap(c,"on",e=>requestOnWrapper(e,p));try{l.wrap(c,"write",(function(e){return function(...t){try{x&&""!==x||!t[0]||!("string"==typeof t[0]||t[0]instanceof Buffer)||Ke(R,"request_body",t[0])}catch(e){T.debugLog("Could not parse request body in write wrapper")}return e.apply(this,t)}})),l.wrap(c,"end",(function(e){return function(...t){try{x&&""!==x||!t[0]||!("string"==typeof t[0]||t[0]instanceof Buffer)||Ke(R,"request_body",t[0])}catch(e){T.debugLog("Could not parse request body in end wrapper")}return e.apply(this,t)}}))}catch(e){}const O=new Promise(e=>{let t=!1;c.on("timeout",()=>{t=!0}),c.once("error",r=>{const a=new Error;if(a.message=r.message,a.stack=r.stack,a.name=r.name,t&&(a.message+="\nTimeout exceeded"),c.aborted&&(a.message+="\nRequest aborted"),j.setException(R,a),je(R,e,M),0===c.listenerCount("error"))throw r});c.on("response",t=>{T.debugLog("[http] response arrived for "+d),(()=>{if(o){if(o.epsagonSkipResponseData)return!0;if(o.agent&&o.agent.epsagonSkipResponseData)return!0}return!!B.getConfig().disableHttpResponseBodyCapture})()||t.on("data",e=>Ge(e,p)),t.on("end",()=>{const r=t.headers&&t.headers["content-encoding"];Ke(R,"response_body",Buffer.concat(p),r),je(R,e,M)})},"skip")}).catch(e=>{pe.addException(e)});pe.addEvent(R,O),T.debugLog("[http] event added "+d)}catch(e){pe.addException(e)}return c||(T.debugLog("[http] not client request set"),c=e.apply(this,[r,a,n])),T.debugLog("[http] done handling call"),c}}function httpGetWrapper(e){return function(t,r,a){const n=e.request(t,r,a);return n.end(),n}}function fetchH2Wrapper(e){return function(t){return e.apply(this,[{...t,epsagonSkipResponseData:!0}])}}function clientRequestWrapper(e){return function(t,r,a){const n=a||{};return n.headers?n.headers={...a.headers,epsagonSkipResponseData:!0}:n.headers={epsagonSkipResponseData:!0},e.apply(this,[t,r,n])}}var Je={init(){l.wrap(p,"get",()=>httpGetWrapper(p)),l.wrap(p,"request",httpWrapper),l.wrap(i,"get",()=>httpGetWrapper(i)),l.wrap(i,"request",httpWrapper),Ce.patchModule("fetch-h2/dist/lib/context-http1","connect",fetchH2Wrapper,e=>e.OriginPool.prototype),Ce.patchModule("simple-oauth2/lib/client.js","request",clientRequestWrapper,e=>e.prototype),Ce.patchModule("simple-oauth2/lib/client/client.js","request",clientRequestWrapper,e=>e.prototype)}};const{MAX_HTTP_VALUE_SIZE:Qe}=q,{isBlacklistURL:Ve,isBlacklistHeader:Ze}=ie,{isURLIgnoredByUser:Xe,resolveHttpPromise:Ye,USER_AGENTS_BLACKLIST:et,URL_BLACKLIST:tt,generateEpsagonTraceId:rt,updateAPIGateway:at,setJsonPayload:nt}=Re,st=Y("http2");function extractHeaders(e){return Object.entries(e).filter(e=>!e[0].startsWith(":")).reduce((e,t)=>{const[r,a]=t;return e[r]=a,e},{})}function wrapHttp2Connect(e){return function(t,r,a){const n=e.apply(this,[t,r,a]);try{l.wrap(n,"request",e=>function(e,t){return function(r,a){let n=null,s=null,o=null;try{const{hostname:n}=_.parse(t);if(Ve(n,tt,r[":path"])||Xe(n))return T.debugLog("filtered blacklist hostname "+n),e.apply(this,[r,a]);const i=extractHeaders(r);if(Ze(i,et))return T.debugLog("filtered blacklist headers"),e.apply(this,[r,a]);const p=rt();r["epsagon-trace-id"]=p;const{slsEvent:c,startTime:u}=j.initializeEvent("http",n,r[":method"],"http");s=c,o=u,j.addToMetadata(s,{http_trace_id:p},{path:r[":path"],request_headers:i})}catch(t){return pe.addException(t),e.apply(this,[r,a])}try{n=e.apply(this,[r,a])}catch(e){throw j.setException(s,e),pe.addEvent(s),e}try{const e=new Promise(e=>{const t=[];let r;B.getConfig().disableHttpResponseBodyCapture||n.on("data",e=>{e&&t.reduce((e,t)=>t.length+e,0)+e.length<=Qe&&t.push("string"==typeof e?Buffer.from(e):e)}),n.once("error",t=>{if(j.setException(s,t),Ye(s,e,o),0===n.listenerCount("error"))throw t}),n.once("close",()=>{const a=r&&r["content-encoding"];nt(s,"response_body",Buffer.concat(t),a),Ye(s,e,o)}),n.once("response",e=>{at(e,s),r=extractHeaders(e),j.addToMetadata(s,{status:e[":status"]},{response_headers:r})})}).catch(e=>{pe.addException(e)});pe.addEvent(s,e)}catch(e){pe.addException(e)}return n}}(e,t))}catch(e){T.debugLog("Could not instrument http2 session request "+e)}return n}}var ot={init(){st&&(T.debugLog("Patching http2 module"),l.wrap(st,"connect",wrapHttp2Connect))}};function peg$SyntaxError(e,t,r,a){this.message=e,this.expected=t,this.found=r,this.location=a,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,peg$SyntaxError)}!function(e,t){function ctor(){this.constructor=e}ctor.prototype=t.prototype,e.prototype=new ctor}(peg$SyntaxError,Error),peg$SyntaxError.buildMessage=function(e,t){var r={literal:function(e){return'"'+literalEscape(e.text)+'"'},class:function(e){var t,r="";for(t=0;t<e.parts.length;t++)r+=e.parts[t]instanceof Array?classEscape(e.parts[t][0])+"-"+classEscape(e.parts[t][1]):classEscape(e.parts[t]);return"["+(e.inverted?"^":"")+r+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function hex(e){return e.charCodeAt(0).toString(16).toUpperCase()}function literalEscape(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+hex(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+hex(e)}))}function classEscape(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+hex(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+hex(e)}))}return"Expected "+function(e){var t,a,n,s=new Array(e.length);for(t=0;t<e.length;t++)s[t]=(n=e[t],r[n.type](n));if(s.sort(),s.length>0){for(t=1,a=1;t<s.length;t++)s[t-1]!==s[t]&&(s[a]=s[t],a++);s.length=a}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(e)+" but "+function(e){return e?'"'+literalEscape(e)+'"':"end of input"}(t)+" found."};var it={SyntaxError:peg$SyntaxError,parse:function(e,t){t=void 0!==t?t:{};var r,a={},n={start:peg$parsestart},s=peg$parsestart,o="(",i=peg$literalExpectation("(",!1),p=")",c=peg$literalExpectation(")",!1),u=peg$literalExpectation(";",!1),d="=",l=peg$literalExpectation("=",!1),g=peg$literalExpectation("KEY",!0),f="index",h=peg$literalExpectation("INDEX",!0),_=peg$otherExpectation("column_clause"),peg$c28=function(e,t){return createList(e,t)},m="`",E=peg$literalExpectation("`",!1),peg$c51=function(e,t){var r={type:"expr_list"},a=function(e,t,r){for(var a,n=createList(e,t),s=[],o=0;o<n.length;o++)"param"==(a=n[o]).type?(a.room=r,a.pos=o):s.push(a);return s}(e,t,r);return r.value=a,r},peg$c54=function(e,t){return createBinaryExprChain(e,t)},b=peg$literalExpectation("!",!1),y=peg$literalExpectation(">=",!1),v=peg$literalExpectation(">",!1),$=peg$literalExpectation("<=",!1),T=peg$literalExpectation("<>",!1),x=peg$literalExpectation("<",!1),S=peg$literalExpectation("!=",!1),peg$c72=function(e,t){return{op:e,right:t}},peg$c74=function(e){return e[0]+" "+e[2]},peg$c75=function(e,t){return{op:e,right:t}},peg$c76=function(e,t){return{op:e,right:t}},A=peg$literalExpectation("+",!1),M=peg$literalExpectation("-",!1),R="*",C=peg$literalExpectation("*",!1),O=peg$literalExpectation("/",!1),w=peg$literalExpectation("%",!1),peg$c88=function(e){return e.paren=!0,e},peg$c91=function(e){return!0===Xt[e.toUpperCase()]},N=/^[^`]/,L=peg$classExpectation(["`"],!0,!1),peg$c96=function(e,t){return e+t.join("")},I=/^[A-Za-z_]/,D=peg$classExpectation([["A","Z"],["a","z"],"_"],!1,!1),P=/^[A-Za-z0-9_]/,k=peg$classExpectation([["A","Z"],["a","z"],["0","9"],"_"],!1,!1),W=/^[A-Za-z0-9_:]/,q=peg$classExpectation([["A","Z"],["a","z"],["0","9"],"_",":"],!1,!1),B=peg$otherExpectation("PARAM[:param, ?]"),j=peg$literalExpectation(":",!1),U=peg$literalExpectation("?",!1),F=/^[0-9a-zA-Z_]/,z=peg$classExpectation([["0","9"],["a","z"],["A","Z"],"_"],!1,!1),H='"',K=peg$literalExpectation('"',!1),G="'",J=peg$literalExpectation("'",!1),Q=/^[^'\\\0-\x1F\x7F]/,V=peg$classExpectation(["'","\\",["\0",""],""],!0,!1),Z=/^[^"\\\0-\x1F\x7F]/,X=peg$classExpectation(['"',"\\",["\0",""],""],!0,!1),Y=peg$literalExpectation("\\'",!1),ee=peg$literalExpectation('\\"',!1),te=peg$literalExpectation("\\\\",!1),re=peg$literalExpectation("\\/",!1),ae=peg$literalExpectation("\\b",!1),ne=peg$literalExpectation("\\f",!1),se=peg$literalExpectation("\\n",!1),oe=peg$literalExpectation("\\r",!1),ie=peg$literalExpectation("\\t",!1),pe=peg$literalExpectation("\\u",!1),ce=peg$otherExpectation("LITERAL INT"),ue=".",de=peg$literalExpectation(".",!1),le=peg$otherExpectation("NUMBER"),ge=/^[0-9]/,fe=peg$classExpectation([["0","9"]],!1,!1),he=/^[1-9]/,_e=peg$classExpectation([["1","9"]],!1,!1),me=peg$otherExpectation("HEX"),Ee=/^[0-9a-fA-F]/,be=peg$classExpectation([["0","9"],["a","f"],["A","F"]],!1,!1),ye=/^[eE]/,ve=peg$classExpectation(["e","E"],!1,!1),$e=/^[+\-]/,Te=peg$classExpectation(["+","-"],!1,!1),xe="null",Se=peg$literalExpectation("NULL",!0),Ae="true",Me=peg$literalExpectation("TRUE",!0),Re="false",Ce=peg$literalExpectation("FALSE",!0),Oe="select",we=peg$literalExpectation("SELECT",!0),Ne="update",Le=peg$literalExpectation("UPDATE",!0),Ie="create",De=peg$literalExpectation("CREATE",!0),Pe="delete",ke=peg$literalExpectation("DELETE",!0),We="insert",qe=peg$literalExpectation("INSERT",!0),Be="replace",je=peg$literalExpectation("REPLACE",!0),Ue="into",Fe=peg$literalExpectation("INTO",!0),ze="from",He=peg$literalExpectation("FROM",!0),Ke=peg$literalExpectation("SET",!0),Ge=peg$literalExpectation("AS",!0),Je="table",Qe=peg$literalExpectation("TABLE",!0),Ve=peg$literalExpectation("ON",!0),Ze="left",Xe=peg$literalExpectation("LEFT",!0),Ye="inner",et=peg$literalExpectation("INNER",!0),tt=peg$literalExpectation("JOIN",!0),rt=peg$literalExpectation("UNION",!0),at="values",nt=peg$literalExpectation("VALUES",!0),st=peg$literalExpectation("IF",!0),ot="exists",it=peg$literalExpectation("EXISTS",!0),pt="where",ct=peg$literalExpectation("WHERE",!0),ut="group",dt=peg$literalExpectation("GROUP",!0),lt=peg$literalExpectation("BY",!0),gt="order",ft=peg$literalExpectation("ORDER",!0),ht="limit",_t=peg$literalExpectation("LIMIT",!0),mt=peg$literalExpectation("ASC",!0),Et="desc",bt=peg$literalExpectation("DESC",!0),yt=peg$literalExpectation("ALL",!0),vt=peg$literalExpectation("DISTINCT",!0),$t="between",Tt=peg$literalExpectation("BETWEEN",!0),xt=peg$literalExpectation("IN",!0),St=peg$literalExpectation("IS",!0),At=peg$literalExpectation("LIKE",!0),Mt=peg$literalExpectation("CONTAINS",!0),Rt=peg$literalExpectation("NOT",!0),Ct=peg$literalExpectation("AND",!0),Ot=peg$literalExpectation("OR",!0),wt="count",Nt=peg$literalExpectation("COUNT",!0),Lt=peg$literalExpectation(",",!1),It=peg$literalExpectation("[",!1),Dt=peg$literalExpectation("]",!1),Pt=peg$otherExpectation("WHITE_SPACE"),kt=/^[ \t\n\r]/,Wt=peg$classExpectation([" ","\t","\n","\r"],!1,!1),qt=peg$literalExpectation("$",!1),Bt="return",jt=peg$literalExpectation("return",!0),Ut=":=",Ft=peg$literalExpectation(":=",!1),zt=0,Ht=[{line:1,column:1}],Kt=0,Gt=[],Jt=0;if("startRule"in t){if(!(t.startRule in n))throw new Error("Can't start parsing from rule \""+t.startRule+'".');s=n[t.startRule]}function peg$literalExpectation(e,t){return{type:"literal",text:e,ignoreCase:t}}function peg$classExpectation(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function peg$otherExpectation(e){return{type:"other",description:e}}function peg$computePosDetails(t){var r,a=Ht[t];if(a)return a;for(r=t-1;!Ht[r];)r--;for(a={line:(a=Ht[r]).line,column:a.column};r<t;)10===e.charCodeAt(r)?(a.line++,a.column=1):a.column++,r++;return Ht[t]=a,a}function peg$computeLocation(e,t){var r=peg$computePosDetails(e),a=peg$computePosDetails(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:a.line,column:a.column}}}function peg$fail(e){zt<Kt||(zt>Kt&&(Kt=zt,Gt=[]),Gt.push(e))}function peg$parsestart(){var t,r,n,s;return t=zt,(r=peg$parse__())!==a?((n=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseselect_stmt())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_UNION())!==a&&(i=peg$parse__())!==a&&(p=peg$parseselect_stmt())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_UNION())!==a&&(i=peg$parse__())!==a&&(p=peg$parseselect_stmt())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=function(e,t){for(var r=e,a=0;a<t.length;a++)r._next=t[a][3],r=r._next;return e}(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())===a&&(n=function(){var t,r,n,s;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Ne?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(Le));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parsetable_name())!==a&&peg$parse__()!==a&&function(){var t,r,n,s;t=zt,"set"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(Ke));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(n=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseset_item())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseset_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseset_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a&&peg$parse__()!==a&&(s=peg$parsewhere_clause())!==a?(i=n,p=s,t={type:"update",db:(o=r).db,table:o.table,set:i,where:p}):(zt=t,t=a);var o,i,p;return t}())===a&&(n=function(){var t,r,n;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Pe?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(ke));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parsefrom_clause())!==a&&peg$parse__()!==a?((n=peg$parsewhere_clause())===a&&(n=null),n!==a?t={type:"delete",from:r,where:n}:(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(n=function(){var t,r,n,s,o;t=zt,(r=function(){var t,r;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===We?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(qe));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r="insert");(t=r)===a&&(t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,7).toLowerCase()===Be?(r=e.substr(zt,7),zt+=7):(r=a,0===Jt&&peg$fail(je));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r="replace"),t=r);return t}())!==a&&peg$parse__()!==a&&function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Ue?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Fe));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(n=peg$parsetable_name())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(s=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsecolumn())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a&&peg$parse__()!==a&&(o=function(){var t,r;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===at?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(nt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsevalue_item())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsevalue_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsevalue_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a?t=r:(zt=t,t=a);return t}())!==a?(p=s,c=o,t=r={type:r,db:(i=n).db,table:i.table,columns:p,values:c}):(zt=t,t=a);var i,p,c;return t}())===a&&(n=function(){var t,r,n,s,d,l,g,f,h,_,m,E,b;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Ie?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(De));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===Je?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(Qe));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a?(r=zt,(n=function(){var t,r,n,s;t=zt,"if"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(st));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(s=peg$parse__())!==a&&(d=peg$parseKW_NOT())!==a&&(l=peg$parse__())!==a&&(g=function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===ot?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(it));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(f=peg$parse__())!==a?r=n=[n,s,d,l,g,f]:(zt=r,r=a),r===a&&(r=null),r!==a&&(n=peg$parsetable_name())!==a&&(s=peg$parse__())!==a?(40===e.charCodeAt(zt)?(d=o,zt++):(d=a,0===Jt&&peg$fail(i)),d!==a&&(l=peg$parse__())!==a&&(g=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsecolumn_def())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_def())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_def())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=createList(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a&&(f=peg$parse__())!==a?(41===e.charCodeAt(zt)?(h=p,zt++):(h=a,0===Jt&&peg$fail(c)),h!==a&&peg$parse__()!==a?((_=function(){var e,t,r,n,s,o;if(e=zt,(t=peg$parsetable_option())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parsetable_option())!==a?n=s=[s,o]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parsetable_option())!==a?n=s=[s,o]:(zt=n,n=a);r!==a?e=t=function(e,t){let r=e;return t.forEach(e=>{let t=e[1];Object.keys(t).forEach(e=>{r[e]=t[e].column})}),r}(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())===a&&(_=null),_!==a&&peg$parse__()!==a?((m=function(){var e,t,r,n,s,o;if(e=zt,(t=peg$parseprimary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseprimary())!==a?n=s=[s,o]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseprimary())!==a?n=s=[s,o]:(zt=n,n=a);r!==a?e=t=function(e,t){let r=[e];return t.forEach(e=>{r.push(e)}),r}(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())===a&&(m=null),m!==a&&peg$parse__()!==a?(59===e.charCodeAt(zt)?(E=";",zt++):(E=a,0===Jt&&peg$fail(u)),E===a&&(E=null),E!==a?((b=peg$parse__())===a&&(b=null),b!==a?t={type:"create_table",name:n,columns:g,tableOptions:_,partitionOptions:m}:(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a);return t}()),n!==a?((s=n).params=Yt,t=r=s):(zt=t,t=a)):(zt=t,t=a),t===a&&(t=zt,(r=function(){var e,t;e=[],t=peg$parseproc_stmt();for(;t!==a;)e.push(t),t=peg$parseproc_stmt();return e}())!==a&&(r=r),t=r),t}function peg$parsecolumn_def(){var t,r,n,s,u,d,l;if((t=function(){var t,r,n,s,u,d,l,_;t=zt,r=zt,n=zt,s=[],u=peg$parseident_name();for(;u!==a;)s.push(u),u=peg$parseident_name();s!==a&&(u=peg$parse__())!==a?("key"===e.substr(zt,3).toLowerCase()?(d=e.substr(zt,3),zt+=3):(d=a,0===Jt&&peg$fail(g)),d===a&&(e.substr(zt,5).toLowerCase()===f?(d=e.substr(zt,5),zt+=5):(d=a,0===Jt&&peg$fail(h))),d!==a?n=s=[s,u,d]:(zt=n,n=a)):(zt=n,n=a);r=n!==a?e.substring(r,zt):n;r!==a&&(n=peg$parse__())!==a&&(s=peg$parsecolumn())!==a&&(u=peg$parse__())!==a?(40===e.charCodeAt(zt)?(d=o,zt++):(d=a,0===Jt&&peg$fail(i)),d!==a&&(l=peg$parsecolumn_clause())!==a?(41===e.charCodeAt(zt)?(_=p,zt++):(_=a,0===Jt&&peg$fail(c)),_!==a?t=r=function(e,t,r){let a=[];return r.forEach(e=>{a.push(e.expr.column)}),{type:e,name:t,columns:a}}(r,s,l):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a);return t}())===a)if(t=zt,(r=peg$parsecolumn())!==a)if(peg$parse__()!==a)if((n=function(){var e;zt,(e=peg$parsefunc_call())===a&&(e=peg$parseident());e!==a&&(e=function(e){if("function"===e.type){let t=[];return e.args.value.forEach(e=>{t.push(e.value)}),{type:e.name,args:t}}return{type:e}}(e));return e}())!==a){for(s=[],u=zt,(d=peg$parse__())!==a?((l=peg$parseliteral())===a&&(l=peg$parseident_name()),l!==a?u=d=[d,l]:(zt=u,u=a)):(zt=u,u=a);u!==a;)s.push(u),u=zt,(d=peg$parse__())!==a?((l=peg$parseliteral())===a&&(l=peg$parseident_name()),l!==a?u=d=[d,l]:(zt=u,u=a)):(zt=u,u=a);s!==a?t=r=function(e,t,r){let a=[];return r.forEach(e=>{a.push(e[1])}),{name:e,type:t,ext:a}}(r,n,s):(zt=t,t=a)}else zt=t,t=a;else zt=t,t=a;else zt=t,t=a;return t}function peg$parsetable_option(){var t,r,n,s;return t=zt,(r=peg$parseprimary())!==a&&peg$parse__()!==a?(61===e.charCodeAt(zt)?(n=d,zt++):(n=a,0===Jt&&peg$fail(l)),n===a&&(n=null),n!==a&&peg$parse__()!==a&&(s=peg$parseprimary())!==a?t=r=function(e,t){let r={},a="column_ref"===e.type?e.column:e.value,n="column_ref"===t.type?t.column:t.value;return r[a]=n,r}(r,s):(zt=t,t=a)):(zt=t,t=a),t}function peg$parseselect_stmt(){var t,r,n,s,u,d,l;return(t=function(){var t,r,n,s,o,i,p,c;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Oe?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(we));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a?((r=peg$parseKW_DISTINCT())===a&&(r=null),r!==a&&peg$parse__()!==a&&(n=peg$parsecolumn_clause())!==a&&peg$parse__()!==a?((s=peg$parsefrom_clause())===a&&(s=null),s!==a&&peg$parse__()!==a?((o=peg$parsewhere_clause())===a&&(o=null),o!==a&&peg$parse__()!==a?((i=function(){var t,r;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===ut?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(dt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&peg$parseKW_BY()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsecolumn_ref())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_ref())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_ref())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a?t=r:(zt=t,t=a);return t}())===a&&(i=null),i!==a&&peg$parse__()!==a?((p=function(){var t,r;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===gt?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(ft));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&peg$parseKW_BY()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseorder_by_element())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseorder_by_element())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseorder_by_element())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a?t=r:(zt=t,t=a);return t}())===a&&(p=null),p!==a&&peg$parse__()!==a?((c=function(){var t,r,n,s,o,i;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===ht?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(_t));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parseint_or_param())!==a&&peg$parse__()!==a?(n=zt,(s=peg$parseCOMMA())!==a&&(o=peg$parse__())!==a&&(i=peg$parseint_or_param())!==a?n=s=[s,o,i]:(zt=n,n=a),n===a&&(n=null),n!==a?(c=[r],(p=n)?c.push(p[2]):c.unshift({type:"number",value:0}),t=c):(zt=t,t=a)):(zt=t,t=a);var p,c;return t}())===a&&(c=null),c!==a?t={type:"select",distinct:r,columns:n,from:s,where:o,groupby:i,orderby:p,limit:c}:(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(t=zt,r=zt,40===e.charCodeAt(zt)?(n=o,zt++):(n=a,0===Jt&&peg$fail(i)),n!==a&&(s=peg$parse__())!==a&&(u=peg$parseselect_stmt())!==a&&(d=peg$parse__())!==a?(41===e.charCodeAt(zt)?(l=p,zt++):(l=a,0===Jt&&peg$fail(c)),l!==a?r=n=[n,s,u,d,l]:(zt=r,r=a)):(zt=r,r=a),r!==a&&(r=r[2]),t=r),t}function peg$parsecolumn_clause(){var t,r,n,s,o,i,p,c;if(Jt++,t=zt,(r=function(){var t,r,n,s;t=zt,"all"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(yt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="ALL":(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(r=zt,(n=function(){var t;42===e.charCodeAt(zt)?(t=R,zt++):(t=a,0===Jt&&peg$fail(C));return t}())!==a?(s=zt,Jt++,o=peg$parseident_start(),Jt--,o===a?s=void 0:(zt=s,s=a),s!==a?r=n=[n,s]:(zt=r,r=a)):(zt=r,r=a)),r!==a&&(r="*"),(t=r)===a)if(t=zt,(r=peg$parsecolumn_list_item())!==a){for(n=[],s=zt,(o=peg$parse__())!==a&&(i=peg$parseCOMMA())!==a&&(p=peg$parse__())!==a&&(c=peg$parsecolumn_list_item())!==a?s=o=[o,i,p,c]:(zt=s,s=a);s!==a;)n.push(s),s=zt,(o=peg$parse__())!==a&&(i=peg$parseCOMMA())!==a&&(p=peg$parse__())!==a&&(c=peg$parsecolumn_list_item())!==a?s=o=[o,i,p,c]:(zt=s,s=a);n!==a?t=r=peg$c28(r,n):(zt=t,t=a)}else zt=t,t=a;return Jt--,t===a&&(r=a,0===Jt&&peg$fail(_)),t}function peg$parsecolumn_list_item(){var e,t,r;return e=zt,(t=peg$parseadditive_expr())!==a&&peg$parse__()!==a?((r=function(){var e,t,r;e=zt,(t=peg$parseKW_AS())===a&&(t=null);t!==a&&peg$parse__()!==a&&(r=peg$parseident())!==a?e=t=r:(zt=e,e=a);return e}())===a&&(r=null),r!==a?e=t={expr:t,as:r}:(zt=e,e=a)):(zt=e,e=a),e}function peg$parsefrom_clause(){var t,r;return t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===ze?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(He));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n;if(e=zt,(t=peg$parsetable_base())!==a){for(r=[],n=peg$parsetable_ref();n!==a;)r.push(n),n=peg$parsetable_ref();r!==a?(s=t,(o=r).unshift(s),e=t=o):(zt=e,e=a)}else zt=e,e=a;var s,o;return e}())!==a?t=r:(zt=t,t=a),t}function peg$parsetable_ref(){var e,t,r;return e=zt,peg$parse__()!==a&&(t=peg$parseCOMMA())!==a&&peg$parse__()!==a&&(r=peg$parsetable_base())!==a?e=r:(zt=e,e=a),e===a&&(e=zt,peg$parse__()!==a&&(t=function(){var e,t,r,n;e=zt,(t=peg$parsejoin_op())!==a&&peg$parse__()!==a&&(r=peg$parsetable_base())!==a&&peg$parse__()!==a?((n=peg$parseon_clause())===a&&(n=null),n!==a?(s=t,i=n,(o=r).join=s,o.on=i,e=t=o):(zt=e,e=a)):(zt=e,e=a);var s,o,i;return e}())!==a?e=t:(zt=e,e=a)),e}function peg$parsetable_base(){var e,t,r,n,s,o;return e=zt,(t=peg$parsetable_name())!==a&&peg$parse__()!==a?((r=peg$parseKW_AS())===a&&(r=null),r!==a&&peg$parse__()!==a?((n=peg$parseident())===a&&(n=null),n!==a?(o=n,e=t="var"==(s=t).type?(s.as=o,s):{db:s.db,table:s.table,as:o}):(zt=e,e=a)):(zt=e,e=a)):(zt=e,e=a),e}function peg$parsejoin_op(){var t,r,n,s;return t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Ze?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Xe));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_JOIN())!==a?t=r="LEFT JOIN":(zt=t,t=a),t===a&&(t=zt,r=zt,(n=function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===Ye?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(et));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(s=peg$parse__())!==a?r=n=[n,s]:(zt=r,r=a),r===a&&(r=null),r!==a&&(n=peg$parseKW_JOIN())!==a?t=r="INNER JOIN":(zt=t,t=a)),t}function peg$parsetable_name(){var t,r,n,s,o,i,p,c,u,d,l,g;return t=zt,96===e.charCodeAt(zt)?(r=m,zt++):(r=a,0===Jt&&peg$fail(E)),r===a&&(r=null),r!==a&&(n=peg$parseident())!==a?(s=zt,(o=peg$parse__())!==a&&(i=peg$parseDOT())!==a&&(p=peg$parse__())!==a&&(c=peg$parseident_name())!==a?s=o=[o,i,p,c]:(zt=s,s=a),s===a&&(s=null),s!==a?(96===e.charCodeAt(zt)?(o=m,zt++):(o=a,0===Jt&&peg$fail(E)),o===a&&(o=null),o!==a?(l={db:"",table:u=n},(d=s)&&(l.db=u,l.table=d[3]),t=r=l):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a),t===a&&(t=zt,(r=peg$parsevar_decl())!==a&&((g=r).db="",g.table=g.name,r=g),t=r),t}function peg$parseon_clause(){var t,r;return t=zt,function(){var t,r,n,s;t=zt,"on"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(Ve));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parseor_expr())!==a?t=r:(zt=t,t=a),t}function peg$parsewhere_clause(){var t,r;return t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===pt?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(ct));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parseor_expr())!==a?t=r:(zt=t,t=a),t}function peg$parseorder_by_element(){var t,r,n,s;return t=zt,(r=peg$parseor_expr())!==a&&peg$parse__()!==a?((n=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Et?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(bt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="DESC":(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(n=function(){var t,r,n,s;t=zt,"asc"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(mt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="ASC":(zt=t,t=a)):(zt=t,t=a);return t}()),n===a&&(n=null),n!==a?(s={expr:r,type:"ASC"},"DESC"==n&&(s.type="DESC"),t=r=s):(zt=t,t=a)):(zt=t,t=a),t}function peg$parseint_or_param(){var e;return(e=function(){var e,t;Jt++,e=zt,(t=peg$parseint())!==a&&(t=function(e){return{type:"number",value:e}}(t));Jt--,(e=t)===a&&(t=a,0===Jt&&peg$fail(ce));return e}())===a&&(e=peg$parseparam()),e}function peg$parseset_item(){var t,r,n,s;return t=zt,(r=peg$parsecolumn_name())!==a&&peg$parse__()!==a?(61===e.charCodeAt(zt)?(n=d,zt++):(n=a,0===Jt&&peg$fail(l)),n!==a&&peg$parse__()!==a&&(s=peg$parseadditive_expr())!==a?t=r={column:r,value:s}:(zt=t,t=a)):(zt=t,t=a),t}function peg$parsevalue_item(){var e,t;return e=zt,peg$parseLPAREN()!==a&&peg$parse__()!==a&&(t=peg$parseexpr_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t:(zt=e,e=a),e}function peg$parseexpr_list(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseor_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseor_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseor_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c51(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseor_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseand_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_OR())!==a&&(i=peg$parse__())!==a&&(p=peg$parseand_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_OR())!==a&&(i=peg$parse__())!==a&&(p=peg$parseand_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseand_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsenot_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_AND())!==a&&(i=peg$parse__())!==a&&(p=peg$parsenot_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_AND())!==a&&(i=peg$parse__())!==a&&(p=peg$parsenot_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parsenot_expr(){var t,r,n,s,o;return t=zt,(r=peg$parseKW_NOT())===a&&(r=zt,33===e.charCodeAt(zt)?(n="!",zt++):(n=a,0===Jt&&peg$fail(b)),n!==a?(s=zt,Jt++,61===e.charCodeAt(zt)?(o=d,zt++):(o=a,0===Jt&&peg$fail(l)),Jt--,o===a?s=void 0:(zt=s,s=a),s!==a?r=n=[n,s]:(zt=r,r=a)):(zt=r,r=a)),r!==a&&(n=peg$parse__())!==a&&(s=peg$parsenot_expr())!==a?t=r={type:"unary_expr",operator:"NOT",expr:s}:(zt=t,t=a),t===a&&(t=peg$parsecomparison_expr()),t}function peg$parsecomparison_expr(){var t,r,n;return t=zt,(r=peg$parseadditive_expr())!==a&&peg$parse__()!==a?((n=function(){var t;(t=function(){var e,t,r,n,s,o;zt,e=[],t=zt,(r=peg$parse__())!==a&&(n=peg$parsearithmetic_comparison_operator())!==a&&(s=peg$parse__())!==a&&(o=peg$parseadditive_expr())!==a?t=r=[r,n,s,o]:(zt=t,t=a);if(t!==a)for(;t!==a;)e.push(t),t=zt,(r=peg$parse__())!==a&&(n=peg$parsearithmetic_comparison_operator())!==a&&(s=peg$parse__())!==a&&(o=peg$parseadditive_expr())!==a?t=r=[r,n,s,o]:(zt=t,t=a);else e=a;e!==a&&(e={type:"arithmetic",tail:e});return e}())===a&&(t=function(){var e,t,r,n;e=zt,(t=peg$parsein_op())!==a&&peg$parse__()!==a&&(r=peg$parseLPAREN())!==a&&peg$parse__()!==a&&(n=peg$parseexpr_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=peg$c75(t,n):(zt=e,e=a);e===a&&(e=zt,(t=peg$parsein_op())!==a&&peg$parse__()!==a&&(r=peg$parsevar_decl())!==a?e=t=peg$c76(t,r):(zt=e,e=a));return e}())===a&&(t=function(){var t,r,n,s;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,7).toLowerCase()===$t?(r=e.substr(zt,7),zt+=7):(r=a,0===Jt&&peg$fail(Tt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="BETWEEN":(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&peg$parse__()!==a&&(n=peg$parseadditive_expr())!==a&&peg$parse__()!==a&&peg$parseKW_AND()!==a&&peg$parse__()!==a&&(s=peg$parseadditive_expr())!==a?t=r={op:r,right:{type:"expr_list",value:[n,s]}}:(zt=t,t=a);return t}())===a&&(t=function(){var t,r,n;t=zt,(r=function(){var t,r,n,s;t=zt,"is"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(St));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="IS":(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&peg$parse__()!==a&&(n=peg$parseadditive_expr())!==a?t=r=peg$c72(r,n):(zt=t,t=a);return t}())===a&&(t=function(){var e,t,r;e=zt,(t=function(){var e,t,r,n,s;e=zt,t=zt,(r=peg$parseKW_NOT())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_LIKE())!==a?t=r=[r,n,s]:(zt=t,t=a);t!==a&&(t=peg$c74(t));(e=t)===a&&(e=peg$parseKW_LIKE());return e}())!==a&&peg$parse__()!==a&&(r=peg$parsecomparison_expr())!==a?e=t=peg$c72(t,r):(zt=e,e=a);return e}())===a&&(t=function(){var e,t,r,n;e=zt,(t=peg$parsecontains_op())!==a&&peg$parse__()!==a&&(r=peg$parseLPAREN())!==a&&peg$parse__()!==a&&(n=peg$parseexpr_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=peg$c75(t,n):(zt=e,e=a);e===a&&(e=zt,(t=peg$parsecontains_op())!==a&&peg$parse__()!==a&&(r=peg$parsevar_decl())!==a?e=t=peg$c76(t,r):(zt=e,e=a));return e}());return t}())===a&&(n=null),n!==a?t=r=function(e,t){if(t)return"arithmetic"==t.type?createBinaryExprChain(e,t.tail):createBinaryExpr(t.op,e,t.right);return e}(r,n):(zt=t,t=a)):(zt=t,t=a),t}function peg$parsearithmetic_comparison_operator(){var t;return">="===e.substr(zt,2)?(t=">=",zt+=2):(t=a,0===Jt&&peg$fail(y)),t===a&&(62===e.charCodeAt(zt)?(t=">",zt++):(t=a,0===Jt&&peg$fail(v)),t===a&&("<="===e.substr(zt,2)?(t="<=",zt+=2):(t=a,0===Jt&&peg$fail($)),t===a&&("<>"===e.substr(zt,2)?(t="<>",zt+=2):(t=a,0===Jt&&peg$fail(T)),t===a&&(60===e.charCodeAt(zt)?(t="<",zt++):(t=a,0===Jt&&peg$fail(x)),t===a&&(61===e.charCodeAt(zt)?(t=d,zt++):(t=a,0===Jt&&peg$fail(l)),t===a&&("!="===e.substr(zt,2)?(t="!=",zt+=2):(t=a,0===Jt&&peg$fail(S)))))))),t}function peg$parsein_op(){var e,t,r,n,s;return e=zt,t=zt,(r=peg$parseKW_NOT())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_IN())!==a?t=r=[r,n,s]:(zt=t,t=a),t!==a&&(t=peg$c74(t)),(e=t)===a&&(e=peg$parseKW_IN()),e}function peg$parsecontains_op(){var e,t,r,n,s;return e=zt,t=zt,(r=peg$parseKW_NOT())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_CONTAINS())!==a?t=r=[r,n,s]:(zt=t,t=a),t!==a&&(t=peg$c74(t)),(e=t)===a&&(e=peg$parseKW_CONTAINS()),e}function peg$parseadditive_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsemultiplicative_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parsemultiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parsemultiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseadditive_operator(){var t;return 43===e.charCodeAt(zt)?(t="+",zt++):(t=a,0===Jt&&peg$fail(A)),t===a&&(45===e.charCodeAt(zt)?(t="-",zt++):(t=a,0===Jt&&peg$fail(M))),t}function peg$parsemultiplicative_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseprimary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseprimary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseprimary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=createBinaryExprChain(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parsemultiplicative_operator(){var t;return 42===e.charCodeAt(zt)?(t=R,zt++):(t=a,0===Jt&&peg$fail(C)),t===a&&(47===e.charCodeAt(zt)?(t="/",zt++):(t=a,0===Jt&&peg$fail(O)),t===a&&(37===e.charCodeAt(zt)?(t="%",zt++):(t=a,0===Jt&&peg$fail(w)))),t}function peg$parseprimary(){var t,r;return(t=peg$parseliteral())===a&&(t=function(){var t;(t=function(){var t,r,n;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===wt?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(Nt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="COUNT":(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(n=function(){var t,r,n;t=zt,(r=function(){var t;zt,42===e.charCodeAt(zt)?(t=R,zt++):(t=a,0===Jt&&peg$fail(C));t!==a&&(t={type:"star",value:"*"});return t}())!==a&&(r={expr:r});(t=r)===a&&(t=zt,(r=peg$parseKW_DISTINCT())===a&&(r=null),r!==a&&peg$parse__()!==a&&(n=peg$parsecolumn_ref())!==a?t=r={distinct:r,expr:n}:(zt=t,t=a));return t}())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?t=r=function(e,t){return{type:"aggr_func",name:e,args:t}}(r,n):(zt=t,t=a);return t}())===a&&(t=function(){var t,r,n;t=zt,(r=function(){var t,r;zt,t=[],F.test(e.charAt(zt))?(r=e.charAt(zt),zt++):(r=a,0===Jt&&peg$fail(z));if(r!==a)for(;r!==a;)t.push(r),F.test(e.charAt(zt))?(r=e.charAt(zt),zt++):(r=a,0===Jt&&peg$fail(z));else t=a;t!==a&&(t=t.join(""));return t}())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(n=peg$parseadditive_expr())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?t=r=function(e,t){return{type:"aggr_func",name:e,args:{expr:t}}}(r,n):(zt=t,t=a);return t}());return t}())===a&&(t=peg$parsefunc_call())===a&&(t=peg$parsecolumn_ref())===a&&(t=peg$parseparam())===a&&(t=zt,peg$parseLPAREN()!==a&&peg$parse__()!==a&&(r=peg$parseor_expr())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?t=peg$c88(r):(zt=t,t=a),t===a&&(t=peg$parsevar_decl())),t}function peg$parsecolumn_ref(){var e,t,r;return e=zt,(t=peg$parseident())!==a&&peg$parse__()!==a&&peg$parseDOT()!==a&&peg$parse__()!==a&&(r=peg$parsecolumn())!==a?e=t={type:"column_ref",table:t,column:r}:(zt=e,e=a),e===a&&(e=zt,(t=peg$parsecolumn())!==a&&(t=function(e){return{type:"column_ref",table:"",column:e}}(t)),e=t),e}function peg$parseident(){var e,t;return e=zt,(t=peg$parseident_name())!==a&&(peg$c91(t)?a:void 0)!==a?e=t=t:(zt=e,e=a),e}function peg$parsecolumn(){var t,r,n,s;if(t=zt,(r=peg$parsecolumn_name())!==a&&(n=(n=peg$c91(r))?a:void 0)!==a?t=r=r:(zt=t,t=a),t===a)if(t=zt,96===e.charCodeAt(zt)?(r=m,zt++):(r=a,0===Jt&&peg$fail(E)),r!==a){if(n=[],N.test(e.charAt(zt))?(s=e.charAt(zt),zt++):(s=a,0===Jt&&peg$fail(L)),s!==a)for(;s!==a;)n.push(s),N.test(e.charAt(zt))?(s=e.charAt(zt),zt++):(s=a,0===Jt&&peg$fail(L));else n=a;n!==a?(96===e.charCodeAt(zt)?(s=m,zt++):(s=a,0===Jt&&peg$fail(E)),s!==a?t=r=n.join(""):(zt=t,t=a)):(zt=t,t=a)}else zt=t,t=a;return t}function peg$parsecolumn_name(){var e,t,r,n;if(e=zt,(t=peg$parseident_start())!==a){for(r=[],n=peg$parsecolumn_part();n!==a;)r.push(n),n=peg$parsecolumn_part();r!==a?e=t=peg$c96(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseident_name(){var e,t,r,n;if(e=zt,(t=peg$parseident_start())!==a){for(r=[],n=peg$parseident_part();n!==a;)r.push(n),n=peg$parseident_part();r!==a?e=t=peg$c96(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseident_start(){var t;return I.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(D)),t}function peg$parseident_part(){var t;return P.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(k)),t}function peg$parsecolumn_part(){var t;return W.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(q)),t}function peg$parseparam(){var t,r,n,s,o;return Jt++,t=zt,58===e.charCodeAt(zt)?(r=":",zt++):(r=a,0===Jt&&peg$fail(j)),r!==a&&(n=peg$parseident_name())!==a?t=r=[r,n]:(zt=t,t=a),t===a&&(t=zt,63===e.charCodeAt(zt)?(r="?",zt++):(r=a,0===Jt&&peg$fail(U)),r!==a&&(o={type:"param",value:(s=r).length>1?s[1]:s[0]},Yt.push(o),r=o),t=r),Jt--,t===a&&(r=a,0===Jt&&peg$fail(B)),t}function peg$parsefunc_call(){var e,t,r;return e=zt,(t=peg$parseident())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(r=function(){var e,t;return(e=peg$parseexpr_list())===a&&(e=zt,(t="")!==a&&(t={type:"expr_list",value:[]}),e=t),e}())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=function(e,t){return{type:"function",name:e,args:t}}(t,r):(zt=e,e=a),e}function peg$parseliteral(){var t;return(t=function(){var t,r,n,s;zt,t=zt,34===e.charCodeAt(zt)?(r=H,zt++):(r=a,0===Jt&&peg$fail(K));if(r!==a){for(n=[],s=peg$parsedouble_char();s!==a;)n.push(s),s=peg$parsedouble_char();n!==a?(34===e.charCodeAt(zt)?(s=H,zt++):(s=a,0===Jt&&peg$fail(K)),s!==a?t=r=[r,n,s]:(zt=t,t=a)):(zt=t,t=a)}else zt=t,t=a;if(t===a)if(t=zt,39===e.charCodeAt(zt)?(r=G,zt++):(r=a,0===Jt&&peg$fail(J)),r!==a){for(n=[],s=peg$parsesingle_char();s!==a;)n.push(s),s=peg$parsesingle_char();n!==a?(39===e.charCodeAt(zt)?(s=G,zt++):(s=a,0===Jt&&peg$fail(J)),s!==a?t=r=[r,n,s]:(zt=t,t=a)):(zt=t,t=a)}else zt=t,t=a;t!==a&&(t={type:"string",value:t[1].join("")});return t}())===a&&(t=function(){var e;zt,(e=function(){var e,t,r,n;e=zt,(t=peg$parseint())!==a&&(r=peg$parsefrac())!==a&&(n=peg$parseexp())!==a&&peg$parse__()!==a?e=t=(s=parseFloat(t+r+n))%1!=0?s.toString():s.toString()+".0":(zt=e,e=a);var s;e===a&&(e=zt,(t=peg$parseint())!==a&&(r=peg$parsefrac())!==a&&(n=peg$parse__())!==a?e=t=function(e,t){var r=parseFloat(e+t);return r%1!=0?r.toString():r.toString()+".0"}(t,r):(zt=e,e=a),e===a&&(e=zt,(t=peg$parseint())!==a&&(r=peg$parseexp())!==a&&(n=peg$parse__())!==a?e=t=function(e,t){return parseFloat(e+t).toString()}(t,r):(zt=e,e=a),e===a&&(e=zt,(t=peg$parseint())!==a&&(r=peg$parse__())!==a?e=t=function(e){return parseFloat(e).toString()}(t):(zt=e,e=a))));return e}())!==a&&(e=function(e){return{type:"number",value:e}}(e));return e}())===a&&(t=function(){var t,r;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Ae?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Me));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r={type:"bool",value:!0});(t=r)===a&&(t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===Re?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(Ce));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r={type:"bool",value:!1}),t=r);return t}())===a&&(t=function(){var t;zt,(t=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===xe?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Se));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(t={type:"null",value:null});return t}()),t}function peg$parsesingle_char(){var t;return Q.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(V)),t===a&&(t=peg$parseescape_char()),t}function peg$parsedouble_char(){var t;return Z.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(X)),t===a&&(t=peg$parseescape_char()),t}function peg$parseescape_char(){var t,r,n,s,o,i,p,c,u,d;return t=zt,"\\'"===e.substr(zt,2)?(r="\\'",zt+=2):(r=a,0===Jt&&peg$fail(Y)),r!==a&&(r="'"),(t=r)===a&&(t=zt,'\\"'===e.substr(zt,2)?(r='\\"',zt+=2):(r=a,0===Jt&&peg$fail(ee)),r!==a&&(r='"'),(t=r)===a&&(t=zt,"\\\\"===e.substr(zt,2)?(r="\\\\",zt+=2):(r=a,0===Jt&&peg$fail(te)),r!==a&&(r="\\"),(t=r)===a&&(t=zt,"\\/"===e.substr(zt,2)?(r="\\/",zt+=2):(r=a,0===Jt&&peg$fail(re)),r!==a&&(r="/"),(t=r)===a&&(t=zt,"\\b"===e.substr(zt,2)?(r="\\b",zt+=2):(r=a,0===Jt&&peg$fail(ae)),r!==a&&(r="\b"),(t=r)===a&&(t=zt,"\\f"===e.substr(zt,2)?(r="\\f",zt+=2):(r=a,0===Jt&&peg$fail(ne)),r!==a&&(r="\f"),(t=r)===a&&(t=zt,"\\n"===e.substr(zt,2)?(r="\\n",zt+=2):(r=a,0===Jt&&peg$fail(se)),r!==a&&(r="\n"),(t=r)===a&&(t=zt,"\\r"===e.substr(zt,2)?(r="\\r",zt+=2):(r=a,0===Jt&&peg$fail(oe)),r!==a&&(r="\r"),(t=r)===a&&(t=zt,"\\t"===e.substr(zt,2)?(r="\\t",zt+=2):(r=a,0===Jt&&peg$fail(ie)),r!==a&&(r="\t"),(t=r)===a&&(t=zt,"\\u"===e.substr(zt,2)?(r="\\u",zt+=2):(r=a,0===Jt&&peg$fail(pe)),r!==a&&(n=peg$parsehexDigit())!==a&&(s=peg$parsehexDigit())!==a&&(o=peg$parsehexDigit())!==a&&(i=peg$parsehexDigit())!==a?(p=n,c=s,u=o,d=i,t=r=String.fromCharCode(parseInt("0x"+p+c+u+d))):(zt=t,t=a)))))))))),t}function peg$parseint(){var t,r,n,s;return t=zt,(r=peg$parsedigit19())!==a&&(n=peg$parsedigits())!==a?t=r=r+n:(zt=t,t=a),t===a&&(t=peg$parsedigit())===a&&(t=zt,45===e.charCodeAt(zt)?(r="-",zt++):(r=a,0===Jt&&peg$fail(M)),r===a&&(43===e.charCodeAt(zt)?(r="+",zt++):(r=a,0===Jt&&peg$fail(A))),r!==a&&(n=peg$parsedigit19())!==a&&(s=peg$parsedigits())!==a?t=r=function(e,t,r){return"-"+t+r}(0,n,s):(zt=t,t=a),t===a&&(t=zt,45===e.charCodeAt(zt)?(r="-",zt++):(r=a,0===Jt&&peg$fail(M)),r===a&&(43===e.charCodeAt(zt)?(r="+",zt++):(r=a,0===Jt&&peg$fail(A))),r!==a&&(n=peg$parsedigit())!==a?t=r="-"+n:(zt=t,t=a))),t}function peg$parsefrac(){var t,r,n;return t=zt,46===e.charCodeAt(zt)?(r=ue,zt++):(r=a,0===Jt&&peg$fail(de)),r!==a&&(n=peg$parsedigits())!==a?t=r="."+n:(zt=t,t=a),t}function peg$parseexp(){var t,r,n;return t=zt,(r=function(){var t,r,n;t=zt,ye.test(e.charAt(zt))?(r=e.charAt(zt),zt++):(r=a,0===Jt&&peg$fail(ve));r!==a?($e.test(e.charAt(zt))?(n=e.charAt(zt),zt++):(n=a,0===Jt&&peg$fail(Te)),n===a&&(n=null),n!==a?t=r=r+n:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(n=peg$parsedigits())!==a?t=r=r+n:(zt=t,t=a),t}function peg$parsedigits(){var e,t;if(zt,e=[],(t=peg$parsedigit())!==a)for(;t!==a;)e.push(t),t=peg$parsedigit();else e=a;return e!==a&&(e=e.join("")),e}function peg$parsedigit(){var t;return Jt++,ge.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(fe)),Jt--,t===a&&0===Jt&&peg$fail(le),t}function peg$parsedigit19(){var t;return Jt++,he.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(_e)),Jt--,t===a&&0===Jt&&peg$fail(le),t}function peg$parsehexDigit(){var t;return Jt++,Ee.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(be)),Jt--,t===a&&0===Jt&&peg$fail(me),t}function peg$parseKW_AS(){var t,r,n,s;return t=zt,"as"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(Ge)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_JOIN(){var t,r,n,s;return t=zt,"join"===e.substr(zt,4).toLowerCase()?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(tt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_UNION(){var t,r,n,s;return t=zt,"union"===e.substr(zt,5).toLowerCase()?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(rt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_BY(){var t,r,n,s;return t=zt,"by"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(lt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_DISTINCT(){var t,r,n,s;return t=zt,"distinct"===e.substr(zt,8).toLowerCase()?(r=e.substr(zt,8),zt+=8):(r=a,0===Jt&&peg$fail(vt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="DISTINCT":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_IN(){var t,r,n,s;return t=zt,"in"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(xt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="IN":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_LIKE(){var t,r,n,s;return t=zt,"like"===e.substr(zt,4).toLowerCase()?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(At)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="LIKE":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_CONTAINS(){var t,r,n,s;return t=zt,"contains"===e.substr(zt,8).toLowerCase()?(r=e.substr(zt,8),zt+=8):(r=a,0===Jt&&peg$fail(Mt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="CONTAINS":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_NOT(){var t,r,n,s;return t=zt,"not"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(Rt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="NOT":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_AND(){var t,r,n,s;return t=zt,"and"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(Ct)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="AND":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_OR(){var t,r,n,s;return t=zt,"or"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(Ot)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="OR":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseDOT(){var t;return 46===e.charCodeAt(zt)?(t=ue,zt++):(t=a,0===Jt&&peg$fail(de)),t}function peg$parseCOMMA(){var t;return 44===e.charCodeAt(zt)?(t=",",zt++):(t=a,0===Jt&&peg$fail(Lt)),t}function peg$parseLPAREN(){var t;return 40===e.charCodeAt(zt)?(t=o,zt++):(t=a,0===Jt&&peg$fail(i)),t}function peg$parseRPAREN(){var t;return 41===e.charCodeAt(zt)?(t=p,zt++):(t=a,0===Jt&&peg$fail(c)),t}function peg$parse__(){var e,t;for(e=[],t=peg$parsewhitespace();t!==a;)e.push(t),t=peg$parsewhitespace();return e}function peg$parsewhitespace(){var t;return Jt++,kt.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(Wt)),Jt--,t===a&&0===Jt&&peg$fail(Pt),t}function peg$parseproc_stmt(){var t,r,n,s;return t=zt,r=zt,Jt++,n=function(){var e;zt,(e="")!==a&&(er=[],e=!0);return e}(),Jt--,n!==a?(zt=r,r=void 0):r=a,r!==a&&(n=peg$parse__())!==a?((s=function(){var t,r,n;t=zt,(r=peg$parsevar_decl())!==a&&peg$parse__()!==a&&function(){var t;e.substr(zt,2)===Ut?(t=Ut,zt+=2):(t=a,0===Jt&&peg$fail(Ft));return t}()!==a&&peg$parse__()!==a&&(n=peg$parseproc_expr())!==a?t=r={type:"assign",left:r,right:n}:(zt=t,t=a);return t}())===a&&(s=function(){var t,r;t=zt,function(){var t;e.substr(zt,6).toLowerCase()===Bt?(t=e.substr(zt,6),zt+=6):(t=a,0===Jt&&peg$fail(jt));return t}()!==a&&peg$parse__()!==a&&(r=peg$parseproc_expr())!==a?t={type:"return",expr:r}:(zt=t,t=a);return t}()),s!==a?t=r={stmt:s,vars:er}:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseproc_expr(){var t;return(t=peg$parseselect_stmt())===a&&(t=function(){var e,t,r,n,s;e=zt,(t=peg$parsevar_decl())!==a&&peg$parse__()!==a&&(r=peg$parsejoin_op())!==a&&peg$parse__()!==a&&(n=peg$parsevar_decl())!==a&&peg$parse__()!==a&&(s=peg$parseon_clause())!==a?e=t={type:"join",ltable:t,rtable:n,op:r,on:s}:(zt=e,e=a);return e}())===a&&(t=peg$parseproc_additive_expr())===a&&(t=function(){var t,r;t=zt,function(){var t;return 91===e.charCodeAt(zt)?(t="[",zt++):(t=a,0===Jt&&peg$fail(It)),t}()!==a&&peg$parse__()!==a&&(r=peg$parseproc_primary_list())!==a&&peg$parse__()!==a&&function(){var t;return 93===e.charCodeAt(zt)?(t="]",zt++):(t=a,0===Jt&&peg$fail(Dt)),t}()!==a?t={type:"array",value:r}:(zt=t,t=a);return t}()),t}function peg$parseproc_additive_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseproc_multiplicative_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_multiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_multiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseproc_multiplicative_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseproc_primary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseproc_primary(){var e,t;return(e=peg$parseliteral())===a&&(e=peg$parsevar_decl())===a&&(e=function(){var e,t,r;e=zt,(t=peg$parseident())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(r=peg$parseproc_primary_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=function(e,t){return{type:"function",name:e,args:{type:"expr_list",value:t}}}(t,r):(zt=e,e=a);return e}())===a&&(e=peg$parseparam())===a&&(e=zt,peg$parseLPAREN()!==a&&peg$parse__()!==a&&(t=peg$parseproc_additive_expr())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=peg$c88(t):(zt=e,e=a)),e}function peg$parseproc_primary_list(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseproc_primary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parsevar_decl(){var t,r,n;return t=zt,function(){var t;36===e.charCodeAt(zt)?(t="$",zt++):(t=a,0===Jt&&peg$fail(qt));return t}()!==a&&(r=peg$parseident_name())!==a&&(n=function(){var t,r,n,s;zt,t=[],r=zt,46===e.charCodeAt(zt)?(n=ue,zt++):(n=a,0===Jt&&peg$fail(de));n!==a&&(s=peg$parseident_name())!==a?r=n=[n,s]:(zt=r,r=a);for(;r!==a;)t.push(r),r=zt,46===e.charCodeAt(zt)?(n=ue,zt++):(n=a,0===Jt&&peg$fail(de)),n!==a&&(s=peg$parseident_name())!==a?r=n=[n,s]:(zt=r,r=a);t!==a&&(t=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r][1]);return t}(t));return t}())!==a?t=function(e,t){return er.push(e),{type:"var",name:e,members:t}}(r,n):(zt=t,t=a),t}function createBinaryExpr(e,t,r){return{type:"binary_expr",operator:e,left:t,right:r}}function createList(e,t){for(var r=[e],a=0;a<t.length;a++)r.push(t[a][3]);return r}function createBinaryExprChain(e,t){for(var r=e,a=0;a<t.length;a++)r=createBinaryExpr(t[a][1],r,t[a][3]);return r}var Qt,Vt,Zt,Xt={SHOW:!0,DROP:!0,SELECT:!0,UPDATE:!0,CREATE:!0,DELETE:!0,INSERT:!0,REPLACE:!0,EXPLAIN:!0,ALL:!0,DISTINCT:!0,AS:!0,TABLE:!0,INTO:!0,FROM:!0,SET:!0,LEFT:!0,ON:!0,INNER:!0,JOIN:!0,UNION:!0,VALUES:!0,EXISTS:!0,WHERE:!0,GROUP:!0,BY:!0,HAVING:!0,ORDER:!0,ASC:!0,DESC:!0,LIMIT:!0,BETWEEN:!0,IN:!0,IS:!0,LIKE:!0,CONTAINS:!0,NOT:!0,AND:!0,OR:!0,TRUE:!0,FALSE:!0,NULL:!0},Yt=[],er=[];if((r=s())!==a&&zt===e.length)return r;throw r!==a&&zt<e.length&&peg$fail({type:"end"}),Qt=Gt,Vt=Kt<e.length?e.charAt(Kt):null,Zt=Kt<e.length?peg$computeLocation(Kt,Kt+1):peg$computeLocation(Kt,Kt),new peg$SyntaxError(peg$SyntaxError.buildMessage(Qt,Vt),Qt,Vt,Zt)}};const{parse:pt}=it;var sql_parseQueryArgs=function(e,t){const r=void 0===t&&e instanceof Function;return{params:r?[]:e,callback:r?e:t}},sql_wrapSqlQuery=function(e,r,a,n,s){let o;try{let i={};try{let t=e.split("`").join("");t.endsWith(";")&&(t=t.substr(0,t.length-1)),i=pt(t)}catch(e){i.type="SQL-Command"}const{type:p,table:c}=i,{database:u,host:d}=n;let l="sql";d.match(".rds.")&&(l="rds"),d.match(".redshift.")&&(l="redshift");const g=new y.Resource([u,l,p]),f=Date.now(),h=new y.Event(["dbapi-"+t(),T.createTimestampFromTime(f),null,s,0,b.ErrorCode.OK]);h.setResource(g),j.addToMetadata(h,{Host:d,Driver:s,Type:p,"Table Name":c},{Query:e.substring(0,2048)}),r&&r.length&&j.addToMetadata(h,{},{Params:r.slice(0,5)});const _=new Promise(e=>{o=(t,r,n)=>{if(T.debugLog("SQL Patched callback was called."),h.setDuration(T.createDurationTimestamp(f)),t)j.setException(h,t);else{let{rowCount:e,rows:t}=r;!e&&r instanceof Array&&(e=r.length,t=r),j.addToMetadata(h,{rowCount:e}),e&&t instanceof Array&&t.length&&(t.length>100&&j.addToMetadata(h,{is_trimmed:!0}),j.addToMetadata(h,{"sql.rows":t.slice(0,100)}))}e(),a&&a(t,r,n)}});pe.addEvent(h,_)}catch(e){pe.addException(e)}return o||a};const ct=process.env.EPSAGON_PG_PATH?`${process.cwd()}${process.env.EPSAGON_PG_PATH}`:"pg";function pgClientWrapper(e){return function(t,r,a){if(t&&t.submit)return e.apply(this,[t,r,a]);const n=sql_parseQueryArgs(r,a);let{params:s}=n;const{callback:o}=n;let i=t,p=s;t&&t.text&&(i=t.text,t.values&&s&&!s.length&&(s=void 0,p=t.values));let c=sql_wrapSqlQuery(i,p,o,this.connectionParameters||this._clients[0],"pg");if(o)return e.apply(this,[t,s,c]);c=c||(()=>{});const u=e.apply(this,[t,s]);return u&&"function"==typeof u.then||c(null,null,null),u.then(e=>(c(null,e,null),e),e=>{throw c(e,null,null),e})}}var ut={init(){process.env.EPSAGON_PG_PATH&&(T.debugLog("EPSAGON_PG_PATH="+process.env.EPSAGON_PG_PATH),T.debugLog("cwd="+process.cwd())),Ce.patchModule(ct,"query",pgClientWrapper,e=>e.Client.prototype),Ce.patchModule("pg-pool","query",pgClientWrapper,e=>e.prototype)}};function mysqlQueryWrapper(e){return function(t,r,a){let n,s,o,i=!1;n="string"!=typeof t?t.sql:t,t.onResult?(o=t.values,s=t.onResult):({params:o,callback:s}=sql_parseQueryArgs(r,a)),void 0===s&&t._callback&&(s=t._callback,i=!0);const p=sql_wrapSqlQuery(n,o,s,this.config,"mysql");return t.onResult?t.onResult=p:s=p,i&&(t._callback=p),e.apply(this,[t,o,s])}}var dt={init(){Ce.patchModule("mysql2","query",mysqlQueryWrapper,e=>e.Connection.prototype),Ce.patchModule("mysql2","execute",mysqlQueryWrapper,e=>e.Connection.prototype),Ce.patchModule("mysql/lib/Connection.js","query",mysqlQueryWrapper,e=>e.prototype)}};function openWhiskWrapper$1(e){return function(r,a){const{name:n}=r,s=`/${process.env.__OW_NAMESPACE}/${n||r}`,o=new y.Resource([s,"openwhisk_action","invoke"]),i=Date.now(),p=new y.Event(["openwhisk-"+t(),T.createTimestampFromTime(i),null,"openwhisk",0,b.ErrorCode.OK]);let c,u;if(p.setResource(o),j.addToMetadata(p,{api_host:r.apihost||process.env.__OW_API_HOST,namespace:r.namespace||process.env.__OW_NAMESPACE},{params:r.params}),r.result){const t={...r,result:!1};c=e.apply(this,[t,a]),u=c.then(e=>e.response.result)}else c=e.apply(this,[r,a]),u=c;const d=new Promise(e=>{c.then(e=>{let t=e.response;t&&t.result&&t.result.body&&t.result.body.length>100&&(t=Object.assign({},t),t.result=Object.assign({},t.result),t.result.body=t.result.body.substring(0,100)+"...(truncated)");const r={activation_id:t.result&&t.result.headers&&t.result.headers["x-last-activation-id"]||e.activationId,status:t.status,result_statusCode:t.result&&t.result.statusCode};j.addToMetadata(p,r,{response:t}),p.setDuration(T.createDurationTimestamp(i))}).catch(e=>{j.setException(p,e)}).finally(()=>{e()})});return pe.addEvent(p,d),u}}var lt={init(){Ce.patchModule("openwhisk/lib/actions.js","invoke",openWhiskWrapper$1,e=>e.prototype)}};const gt="{{projectId}}",ft={type:"pubsub",origin:"google_cloud/pubsub"};function bigQueryWrapper(e){return function(r,a,n){if(-1===r.uri.indexOf("bigquery"))return e.apply(this,[r,a,n]);const s=r.uri.split("googleapis.com/")[1]||"",o=s.split("/"),i=o[0]||"google-cloud",p=o[3]||"Unknown",c=s.split(p+"/")[1].split("/")[0]||"Unknown",u=new y.Resource([p,i,c]),d=Date.now();let l=`${i}-${t()}`,g={};void 0!==r.json?(r.json.jobReference&&(l=r.json.jobReference.jobId),g=r.json):void 0!==r.uri&&(l=r.uri.split("/")[8]);const f=new y.Event([l,T.createTimestampFromTime(d),null,i,0,b.ErrorCode.OK]);let h;f.setResource(u),j.addToMetadata(f,{},g);const _=new Promise(e=>{h=(t,r,a)=>{f.setDuration(T.createDurationTimestamp(d)),j.addToMetadata(f,{},a.body),e(),n(t,r,a)}}).catch(e=>{pe.addException(e)});return pe.addEvent(f,_),e.apply(this,[r,a,h])}}const getMessageData=(e,t)=>{if(Array.isArray(e)&&e.length>t&&e[t].data)try{const r=JSON.parse(""+e[t].data);if("object"==typeof r)return r}catch(e){return null}return null},handlePublishMethod=(e,t)=>{const r=(e=>{const t=e&&e.messageIds?e.messageIds:e;return Array.isArray(t)?t:null})(e);if(r){const e=t.reqOpts&&t.reqOpts.messages;return{messages:r.reduce((t,r,a)=>{let n={id:r};const s=getMessageData(e,a);return s&&(n=Object.assign(n,s)),t.push(n),t},[]),messageIdsArray:r}}return{}},getMessagesFromResponse=e=>{if(e&&e.receivedMessages){const t=[];return{messages:e.receivedMessages.reduce((e,r)=>{const{messageId:a}=r.message;t.push(a);let n={messageId:a};const s=r.message.data&&JSON.parse(""+r.message.data);return s&&"object"==typeof s&&(n=Object.assign(n,s)),e.push(n),e},[]),messageIdsArray:t}}return{}};function wrapPubSubRequestFunction(e){return function(t,r){let a=r;try{const e=this.projectId,{slsEvent:n,startTime:s}=j.initializeEvent(ft.type,e,t.method,ft.origin),o=this,i=new Promise(i=>{a=(a,p,...c)=>{e&&e!==gt||!o.projectId||n.getResource().setName(o.projectId);const u={},d={};switch(p&&t.method){case"publish":{const{messages:e,messageIdsArray:r}=handlePublishMethod(p,t);r&&(u.messageIds=r,r.length&&n.setId(r[0])),e&&(d.messages=e);break}case"createSubscription":u.subscription=p;break;case"deleteSubscription":t.reqOpts&&t.reqOpts.subscription&&(u.subscription=T.getLastSplittedItem(t.reqOpts.subscription,"/"));break;case"createTopic":u.topic=p;break;case"deleteTopic":t.reqOpts&&t.reqOpts.topic&&(u.topic=T.getLastSplittedItem(t.reqOpts.topic,"/"))}j.finalizeEvent(n,s,a,u,d),i(),r&&r(a,p,...c)}});pe.addEvent(n,i)}catch(e){pe.addException(e)}return e.apply(this,[t,a])}}function wrapPubSubPullFunction(e){return function(t,r,a){let n;try{let s;if(t&&t.subscription){const e=t.subscription.split("/");e.length>1&&([,s]=e)}const{slsEvent:o,startTime:i}=j.initializeEvent(ft.type,s,"Pull",ft.origin),patchedCallback=(e,t,r)=>{const n={},s={},{messages:p,messageIdsArray:c}=getMessagesFromResponse(t);c&&(n.messageIds=c,c.length&&o.setId(c[0])),p&&(s.receivedMessages=p),j.finalizeEvent(o,i,e,n,s),r&&r(),a&&a(e,t)};if(a){let n=a;const s=new Promise(e=>{n=(t,r)=>{patchedCallback(t,r,e)}});return pe.addEvent(o,s),e.apply(this,[t,r,n])}n=e.apply(this,[t,r,a]).then(e=>{const[t]=e;return patchedCallback(null,t),e},e=>{throw patchedCallback(e,null),e}),pe.addEvent(o,n)}catch(s){pe.addException(s),n||(n=e.apply(this,[t,r,a]))}return n}}var ht={init(){Ce.patchModule("@google-cloud/common/","makeRequest",bigQueryWrapper,e=>e.util),Ce.patchModule("@google-cloud/pubsub/","request",wrapPubSubRequestFunction,e=>e.PubSub.prototype),Ce.patchModule("@google-cloud/pubsub/","pull",wrapPubSubPullFunction,e=>e.v1.SubscriberClient.prototype)}},_t=getMessageData,mt=handlePublishMethod,Et=getMessagesFromResponse;function redisClientWrapper(e){return function(r){try{if(!1===this.ready||!1===this.stream.writable)return e.apply(this,[r]);const{callback:a}=r,n=this.connection_options.host||"local",s=new y.Resource([this.connection_options.host||"local","redis",r.command]),o=Date.now(),i=new y.Event(["redis-"+t(),T.createTimestampFromTime(o),null,"redis",0,b.ErrorCode.OK]);i.setResource(s),j.addToMetadata(i,{"Redis Host":n,"Redis Port":this.connection_options.port,"Redis DB Index":this.connection_options.db||"0"},{"Command Arguments":r.args});const p=new Promise(e=>{r.callback=(t,r)=>{i.setDuration(T.createDurationTimestamp(o)),t&&j.setException(i,t),e(),a&&a(t,r)}});pe.addEvent(i,p)}catch(e){pe.addException(e)}return e.apply(this,[r])}}ht.getMessageData=_t,ht.handlePublishMethod=mt,ht.getMessagesFromResponse=Et;var bt={init(){Ce.patchModule("redis","internal_send_command",redisClientWrapper,e=>e.RedisClient.prototype)}};function redisClientWrapper$1(e){return function(r,a){try{if("ready"!==this.status)return e.apply(this,[r,a]);const n=this.options.host||"local",s=new y.Resource([n,"redis",r.name]),o=Date.now(),i=new y.Event(["ioredis-"+t(),T.createTimestampFromTime(o),null,"redis",0,b.ErrorCode.OK]);i.setResource(s);const p=Array.isArray(r.args)?r.args:[];j.addToMetadata(i,{"Redis Host":n,"Redis Port":this.options.port,"Redis DB Index":this.options.db||"0"},{"Command Arguments":p.map(e=>e.toString())});const c=new Promise(e=>{r.promise.then(e=>{e&&j.addToMetadata(i,{"redis.response":e.toString()})}).catch(e=>{j.setException(i,e)}).finally(()=>{i.setDuration(T.createDurationTimestamp(o)),e()})});pe.addEvent(i,c)}catch(e){pe.addException(e)}return e.apply(this,[r,a])}}var yt={init(){Ce.patchModule("ioredis","sendCommand",redisClientWrapper$1,e=>e.prototype),Ce.patchModule("dy-ioredis/lib/redis.js","sendCommand",redisClientWrapper$1,e=>e.prototype)}};function getCommandMetadata(e){const t={};if(!e||"object"!=typeof e&&!Array.isArray(e))return t;let r="",a="";return"object"==typeof e&&(r=JSON.stringify(e.filter),a=JSON.stringify(e.query)),r&&(t.filter=r),a&&(t.query=a),0===Object.keys(t).length&&(t.criteria=JSON.stringify(e)),t}function getHostAndPort(e){let t="27017",r="mongodb";if(e&&e.s&&e.s.options){const{options:a}=e.s;t=a.port?a.port:t,r=a.host?a.host:r}return{port:t,host:r}}function getItemsCount(e,t){let r;switch(e){case"find":r=t.result.cursor.firstBatch.length;break;case"insert":case"update":case"delete":r=t.result.n;break;case"getMore":r=t.cursor.nextBatch.length}return r}function getArgsFromFunction(...e){return{server:e[0],namespace:e[1],cmd:"getMore"===e[e.length-2]?{}:e[2],callback:e[e.length-3],operationName:e[e.length-2],wrappedFunction:e[e.length-1]}}function internalMongodbOperationWrapper(...e){const r=getArgsFromFunction(...e),{server:a,namespace:n,cmd:s,callback:o,operationName:i,wrappedFunction:p}=r;let c=o;try{const e=Date.now(),r=getCommandMetadata(s),{host:p,port:u}=getHostAndPort(a),d=new y.Resource([p,"mongodb",i]),l=new y.Event(["mongodb-"+t(),T.createTimestampFromTime(e),null,"mongodb",0,b.ErrorCode.OK]);l.setResource(d),j.addToMetadata(l,{namespace:n},{...r,port:u});const g=new Promise(t=>{c=(r,a)=>{T.debugLog("MongoDb Patched callback was called."),l.setDuration(T.createDurationTimestamp(e)),r?j.setException(l,r):j.addToMetadata(l,{items_count:getItemsCount(i,a)}),t(),o&&o(r,a)}});pe.addEvent(l,g)}catch(e){pe.addException(e)}return arguments[e.length-3]=c,p.apply(this,arguments)}function mongodbInsertWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"insert",e)}}function mongodbUpdateWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"update",e)}}function mongodbRemoveWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"delete",e)}}function mongodbGetMoreWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"getMore",e)}}function mongodbQueryWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"find",e)}}function mongodbCommandWrapper(e){return function(...t){const r=t[2];return r&&r.ismaster?e.apply(this,t):internalMongodbOperationWrapper(...t,r&&"object"==typeof r?Object.keys(r)[0]:"",e)}}var vt={init(){Ce.patchModule("mongodb/lib/core/wireprotocol/index.js","insert",mongodbInsertWrapper,e=>e),Ce.patchModule("mongodb/lib/core/wireprotocol/index.js","update",mongodbUpdateWrapper,e=>e),Ce.patchModule("mongodb/lib/core/wireprotocol/index.js","remove",mongodbRemoveWrapper,e=>e),Ce.patchModule("mongodb/lib/core/wireprotocol/index.js","query",mongodbQueryWrapper,e=>e),Ce.patchModule("mongodb/lib/core/wireprotocol/index.js","getMore",mongodbGetMoreWrapper,e=>e),Ce.patchModule("mongodb/lib/core/wireprotocol/index.js","command",mongodbCommandWrapper,e=>e)}};const{isBlacklistURL:$t}=ie,Tt={"tc.epsagon.com":"endsWith"},xt={resolveAny:"ANY",resolve6:"AAAA",resolve4:"A",resolveCname:"CNAME",resolveMx:"MX",resolveNaptr:"NAPTR",resolveNs:"NS",resolvePtr:"PTR",resolveSoa:"SOA",resolveSrv:"SRV",resolveTxt:"TXT"};function handleFunctionWithoutCallback(e,t,r,a){try{return e.apply(this,a)}catch(e){throw r.setDuration(T.createDurationTimestamp(t)),j.setException(r,e),pe.addEvent(r),e}}function wrapDnsResolveFunction(e){return function(t,r,a){let n,s,o;const{hostname:i,rrtype:p,callback:c}=((e,t,r,a)=>{const n=e;let s=xt.resolve4,o=r;return r&&"object"!=typeof t||(a&&(s=Object.values(xt).find(e=>a.toLocaleLowerCase().includes(("query"+e).toLocaleLowerCase()))),r||(o=t)),{hostname:n,rrtype:s,callback:o}})(t,r,a,e.name);"object"==typeof r&&(o=r);const{slsEvent:u,startTime:d}=j.initializeEvent("dns",e.name,"dns","dns");if(!c)return handleFunctionWithoutCallback(e,d,u,[t,r,a]);try{const t={};o&&(t.options=o),p&&(t.rrtype=p),j.addToMetadata(u,{hostname:i,...t});const r=new Promise(e=>{n=(t,r)=>{const a=((e,t)=>{if(!e)return;let r;return r=t&&t!==xt.resolveTxt?t===xt.resolveAny?{ret:e}:t===xt.resolveSoa?{address:e}:{addresses:e}:{records:e},r})(r,p);j.finalizeEvent(u,d,t,{...a}),e(),c&&c(t,r)}});s=e.apply(this,[i,p,n]),pe.addEvent(u,r)}catch(e){pe.addException(e)}return s||(s=e.apply(this,[t,r,a])),s}}var St={init(){if("TRUE"===(process.env.EPSAGON_DNS_INSTRUMENTATION||"").toUpperCase()){const e=Object.keys(m);Object.keys(xt).forEach(t=>{e.includes(t)&&Ce.patchSingle(m,t,wrapDnsResolveFunction)}),Ce.patchSingle(m,"resolve",()=>wrapDnsResolveFunction(m.resolve)),Ce.patchSingle(m,"reverse",()=>{return e=m.reverse,function(t,r){let a,n;const{slsEvent:s,startTime:o}=j.initializeEvent("dns",e.name,"dns","dns");if(!r)return handleFunctionWithoutCallback(e,o,s,[t,r]);try{j.addToMetadata(s,{ip:t});const i=new Promise(e=>{a=(t,a)=>{j.finalizeEvent(s,o,t,{hostnames:a}),e(),r&&r(t,a)}});n=e.apply(this,[t,a]),pe.addEvent(s,i)}catch(e){pe.addException(e)}return n||(n=e.apply(this,[t,r])),n};var e}),Ce.patchSingle(m,"lookup",()=>{return e=m.lookup,function(t,r,a){let n,s;const{hostname:o,options:i,callback:p}=((e,t,r)=>{let a=t,n=r;return r||(a=void 0,n=t),{hostname:e,options:a,callback:n}})(t,r,a);if($t(o,Tt))return T.debugLog("filtered blacklist hostname "+o),e.apply(this,[t,r,a]);const{slsEvent:c,startTime:u}=j.initializeEvent("dns",e.name,"dns","dns");if(!p)return handleFunctionWithoutCallback(e,u,c,[t,r,a]);try{j.addToMetadata(c,{hostname:o}),i&&j.addToMetadata(c,{options:i});const t=new Promise(e=>{n=(t,r,a)=>{j.finalizeEvent(c,u,t,{address:r,family:a}),e(),p&&p(t,r,a)}}),r=[o,n];i&&r.splice(1,0,i),s=e.apply(this,r),pe.addEvent(c,t)}catch(e){pe.addException(e)}return s||(s=e.apply(this,[t,r,a])),s};var e}),Ce.patchSingle(m,"lookupService",()=>{return e=m.lookupService,function(t,r,a){let n,s;const{slsEvent:o,startTime:i}=j.initializeEvent("dns",e.name,"dns","dns");if(!a)return handleFunctionWithoutCallback(e,i,o,[t,r,a]);try{j.addToMetadata(o,{address:t,port:r});const p=new Promise(e=>{n=(t,r,n)=>{j.finalizeEvent(o,i,t,{hostname:r,service:n}),e(),a&&a(t,r,n)}});s=e.apply(this,[t,r,n]),pe.addEvent(o,p)}catch(e){pe.addException(e)}return s||(s=e.apply(this,[t,r,a])),s};var e})}}};const At="nats",Mt="Client",Rt="unknown",Ct="NATS_BAD_JSON_MSG";function wrapNatsPublishFunction(e,r,a){return function(n,s,o,i){const{subject_internal:p,msg_internal:c,msgJsonStringify:u,opt_reply_internal:d,opt_callback_internal:l,epsagon_id:g}=((e,r,a,n,s)=>{let o,i,p=e,c=r,u=a,d=n;if("function"==typeof p&&(d=p,p=void 0),c=s?void 0===c?null:c:c||"","function"==typeof c&&(d=r,c="",u=void 0),"function"==typeof u&&(d=a,u=void 0),s&&c&&"object"==typeof c&&"TRUE"===(process.env.EPSAGON_PROPAGATE_NATS_ID||"").toUpperCase()&&(i=t(),c.epsagon_id=i),!Buffer.isBuffer(c)&&s)try{o=JSON.stringify(c)}catch(e){o=Ct}return{subject_internal:p,msg_internal:c,msgJsonStringify:o,opt_reply_internal:u,opt_callback_internal:d,epsagon_id:i}})(n,s,o,i,a);let f=l;if(d)return e.apply(this,[n,s,o,i]);try{const{slsEvent:e,startTime:t}=j.initializeEvent(At,n,"publish",At),s={subject:p},o={};a?u&&u!==Ct&&(o.msg=u):o.msg=c,r&&(s.server_host_name=r),g&&(s.epsagon_id=g);const i=new Promise(r=>{f=()=>{j.finalizeEvent(e,t,null,s,o),r(),l&&l()}});pe.addEvent(e,i)}catch(e){pe.addException(e)}return e.apply(this,[p,c,d,f])}}function wrapNatsConnectFunction(e){return function(t,r){const a=e.apply(this,[t,r]);try{if(a&&a.constructor&&a.constructor.name===Mt){const e=(n=a.currentServer).url&&n.url.hostname?n.url.hostname:Rt,t=a.options?a.options.json:null;l.wrap(a,"publish",()=>wrapNatsPublishFunction(a.publish,e,t))}}catch(e){pe.addException(e)}var n;return a}}var Ot={init(){Ce.patchModule("nats","connect",wrapNatsConnectFunction)}};function getPubSubParams(e,t){let r=t,a=e;return"function"==typeof a&&(r=e,a={}),{internalCallback:r,internalOptions:a}}function publishWrapper(e){return function(r,a,n,s){const{internalCallback:o,internalOptions:i}=getPubSubParams(n,s),p=t(),c=function(e,t){if("object"==typeof t)return{...t,epsagonId:e};if("string"==typeof t)try{const r=JSON.parse(t);if(r)return r.epsagonId=e,JSON.stringify(r)}catch(e){}return t}(p,a);let u=o;try{const{slsEvent:e,startTime:t}=j.initializeEvent("mqtt",r,"publish","mqtt"),a={region:this.options.region,protocol:this.options.protocol,host:this.options.host,epsagon_id:p},n={clientId:this.options.clientId,protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion,message:c},s=new Promise(r=>{u=(s,...i)=>{j.finalizeEvent(e,t,s||null,a,n),o&&o(s,...i),r()}});pe.addEvent(e,s)}catch(e){pe.addException(e)}return e.apply(this,[r,c,i,u])}}function onWrapper(e){return function(t,r){let a=r;try{if("message"===t){const e={region:this.options.region,protocol:this.options.protocol,host:this.options.host},t={clientId:this.options.clientId,protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion};a=(a,n,...s)=>{const{slsEvent:o,startTime:i}=j.initializeEvent("mqtt",a,"onMessage","mqtt");t.message=n?n.toString():n;const p=function(e){let t=e;if("object"==typeof t&&Buffer.isBuffer(t)&&(t=t.toString()),"string"==typeof t)try{t=JSON.parse(t)}catch(e){}return t.epsagonId}(n);p&&(e.epsagon_id=p),j.finalizeEvent(o,i,null,e,t),r&&r(a,n,...s),pe.addEvent(o)}}}catch(e){pe.addException(e)}return e.apply(this,[t,a])}}function mqttClientWrapper(e){return function(t,r){const a=e.apply(this,[t,r]);try{l.wrap(a,"publish",e=>publishWrapper(e)),l.wrap(a,"subscribe",e=>{return t=e,function(e,r,a){const{internalCallback:n,internalOptions:s}=getPubSubParams(r,a);let o=n;try{const{slsEvent:t,startTime:r}=j.initializeEvent("mqtt",e,"subscribe","mqtt"),a={region:this.options.region,protocol:this.options.protocol,host:this.options.host},s={clientId:this.options.clientId,protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion},i=new Promise(e=>{o=(o,...i)=>{j.finalizeEvent(t,r,o||null,a,s),n&&n(o,...i),e()}});pe.addEvent(t,i)}catch(e){pe.addException(e)}return t.apply(this,[e,s,o])};var t}),l.wrap(a,"on",e=>onWrapper(e))}catch(e){pe.addException(e)}return a}}var wt={init(){Ce.patchModule("mqtt","MqttClient",mqttClientWrapper,e=>e)}};const{EPSAGON_HEADER:Nt}=q,{generateEpsagonTraceId:Lt}=Re;function kafkaConnectWrapper(e){return function(...t){let r,a,n,s,o;try{const{host:e,port:t}=this.brokerPool.seedBroker.connection;o=t;const{slsEvent:r,startTime:s}=j.initializeEvent("kafka_server",e,"connect","kafkajs");a=r,n=s}catch(e){pe.addException(e)}try{s=e.apply(this,t)}catch(e){throw a&&(a.setException(a,e),pe.addEvent(a)),e}return s=s.catch(e=>{throw r=e,e}).finally(()=>{try{if(!a)return void T.debugLog("Could not initialize kafkajs, skipping response.");j.finalizeEvent(a,n,r,{port:o})}catch(e){pe.addException(e)}}),a&&pe.addEvent(a,s),s}}function kafkaProducerWrapper(e){return function(t){const r=e.apply(this,[t]);if(r&&!r.__epsagonPatched)try{r.__epsagonPatched=!0,l.wrap(r,"send",()=>{return e=r.send,function(t){let r,a,n,s,o;const i=Lt();try{const{slsEvent:e,startTime:n}=j.initializeEvent("kafka",t.topic,"produce","kafkajs");r=e,a=n,t.messages=t.messages.map(e=>(e.headers||(e.headers={}),e.headers[Nt]=i,e))}catch(e){pe.addException(e)}try{n=e.apply(this,[t])}catch(e){throw r&&(j.setException(r,e),pe.addEvent(r)),e}return n=n.then(e=>(o=e,e)).catch(e=>{throw s=e,e}).finally(()=>{try{if(!r)return void T.debugLog("Could not initialize kafkajs, skipping response.");j.finalizeEvent(r,a,s,{messages_count:t.messages.length,[Nt]:i},{messages:t,response:o})}catch(e){pe.addException(e)}}),r&&pe.addEvent(r,n),n};var e})}catch(e){pe.addException(e)}return r}}var It={init(){Ce.patchModule("kafkajs","producer",kafkaProducerWrapper,e=>e.Kafka.prototype),Ce.patchModule("kafkajs/src/cluster/index.js","connect",kafkaConnectWrapper,e=>e.prototype)}};const{EPSAGON_HEADER:Dt}=q,{generateEpsagonTraceId:Pt}=Re;function wrapKafkaSendFunction$1(e){return function(t,r){let a,n,s,o;const i=this,p=Pt(),c=t[0];try{const{slsEvent:e,startTime:r}=j.initializeEvent("kafka",c.topic,"produce","kafka-node");a=e,n=r,t=t.map(e=>{try{if("string"==typeof e.messages){const t=JSON.parse(e.messages);t[Dt]=p,e.messages=JSON.stringify(t)}else{const t=JSON.parse(e.messages[0]);t[Dt]=p,e.messages[0]=JSON.stringify(t)}}catch(e){T.debugLog("kafka-node - Could not extract epsagon header")}return e})}catch(e){pe.addException(e)}const u=new Promise(e=>{o=(t,s)=>{let o;try{if(!a)return T.debugLog("Could not initialize kafka-node, skipping response."),o;j.finalizeEvent(a,n,undefined,{[Dt]:p,host:i.client.options.kafkaHost},{messages:c.messages})}catch(e){pe.addException(e)}finally{r&&"function"==typeof r&&(o=r(t,s))}return e(),o}});try{s=e.apply(this,[t,o])}catch(e){throw a&&(j.setException(a,e),pe.addEvent(a)),e}return a&&pe.addEvent(a,u),s}}var kt={init(){Ce.patchModule("kafka-node","send",wrapKafkaSendFunction$1,e=>e.Producer.prototype)}};function emitWrapper(e){return function(t,...r){if(!pe.isLoggingTracingEnabled())return e.apply(this,[t].concat(r));const a=pe.getTraceId();if(!a)return e.apply(this,[t].concat(r));const n={epsagon:{trace_id:a}};if(!t)return e.apply(this,[t].concat(r));for(const e in t)n[e]=t[e];for(const e of Object.getOwnPropertySymbols(t))n[e]=t[e];return pe.addLoggingTracingEnabledMetadata(),e.apply(this,[n].concat(r))}}var Wt={init(){Ce.patchModule("bunyan","_emit",emitWrapper,e=>e.prototype)}};function logWrapper(e){return function(t,r,a,n){if(!pe.isLoggingTracingEnabled())return e.apply(this,[t,r,a,n]);const s=pe.getTraceId();return s?(t.epsagon={trace_id:s},pe.addLoggingTracingEnabledMetadata(),e.apply(this,[t,r,a,n])):e.apply(this,[t,r,a,n])}}var qt={init(){Ce.patchModule("pino/lib/tools","asJson",logWrapper)}};function blobUploadWrapper(e){return function(t,r){const{accountName:a,containerName:n}=this,{slsEvent:s,startTime:o}=j.initializeEvent("blob_storage",n,"upload","azure-sdk");j.addToMetadata(s,{"azure.blob.account_name":a,"azure.blob.content_size":r},{"azure.blob.content":t});const i=e.apply(this,[t,r]).then(e=>(j.addToMetadata(s,{"azure.blob.error_code":e.errorCode}),s.setDuration(T.createDurationTimestamp(o)),e)).catch(e=>{throw j.setException(s,e),e});return pe.addEvent(s,i),i}}function blobDownloadWrapper(e){return function(t,r,a){const{accountName:n,containerName:s}=this,{slsEvent:o,startTime:i}=j.initializeEvent("blob_storage",s,"download","azure-sdk");j.addToMetadata(o,{"azure.blob.account_name":n,"azure.blob.container_name":s,"azure.blob.offset":t});const p=e.apply(this,[t,r,a]).then(e=>(j.addToMetadata(o,{"azure.blob.content_length":e.contentLength}),o.setDuration(T.createDurationTimestamp(i)),e)).catch(e=>{throw j.setException(o,e),e});return pe.addEvent(o,p),p}}function cosmosCreateItemWrapper(e){return function(t,r){const{id:a,content:n}=t,{container:s,clientContext:o}=this,{database:i}=s,p=s.id,{slsEvent:c,startTime:u}=j.initializeEvent("cosmos_db",p,"create","azure-sdk");j.addToMetadata(c,{"azure.cosmos.endpoint":o.cosmosClientOptions.endpoint,"azure.cosmos.database_id":i.id,"azure.cosmos.item_id":a},{"azure.cosmos.item_content":n});const d=e.apply(this,[t,r]).then(e=>(j.addToMetadata(c,{"azure.cosmos.status_code":e.statusCode}),c.setDuration(T.createDurationTimestamp(u)),e)).catch(e=>{throw j.setException(c,e),e});return pe.addEvent(c,d),d}}var Bt={init(){Ce.patchModule("@azure/storage-blob","upload",blobUploadWrapper,e=>e.BlockBlobClient.prototype),Ce.patchModule("@azure/storage-blob","download",blobDownloadWrapper,e=>e.BlockBlobClient.prototype),Ce.patchModule("@azure/cosmos","create",cosmosCreateItemWrapper,e=>e.Items.prototype)}};function writeWrapper(e){return function(t,r,a){T.debugLog("in internal winston write");const n=function(e){return e&&"object"==typeof e&&pe.isLoggingTracingEnabled()?pe.getTraceId():null}(t);if(T.debugLog("winston traceId="+n),!n)return e.apply(this,[t,r,a]);const s={epsagon:{trace_id:n}};for(const e in t)s[e]=t[e];for(const e of Object.getOwnPropertySymbols(t))s[e]=t[e];return pe.addLoggingTracingEnabledMetadata(),T.debugLog("finish internal winston write"),e.apply(this,[s,r,a])}}var jt={init(){Ce.patchModule("winston/lib/winston/logger","write",writeWrapper,e=>e.prototype)}};const{EPSAGON_HEADER:Ut}=q,{generateEpsagonTraceId:Ft}=Re;function amqplibProducerWrapper(e){return function(t,r,a){let n,s,o;const i=Ft();try{const{slsEvent:e,startTime:r}=j.initializeEvent("rabbitmq",t.routingKey,"SendMessage","amqplib");s=e,o=r,t.headers[Ut]=i}catch(e){pe.addException(e)}try{n=e.apply(this,[t,r,a])}catch(e){throw s&&(j.setException(s,e),pe.addEvent(s)),e}return j.finalizeEvent(s,o,void 0,{exchange:t.exchange,host:this.connection.stream._host,[Ut]:i,"messaging.message_payload_size_bytes":a.toString().length},{headers:t.headers,message:a.toString()}),pe.addEvent(s),n}}var zt={init(){Ce.patchModule("amqplib/lib/channel.js","sendMessage",amqplibProducerWrapper,e=>e.Channel.prototype)}};const{EPSAGON_HEADER:Ht}=q,{generateEpsagonTraceId:Kt}=Re;function amqpProducerWrapper(e){return function(t,r,a,n){let s,o,i;const p=Kt();try{const{slsEvent:e,startTime:r}=j.initializeEvent("rabbitmq",t,"SendMessage","amqplib");o=e,i=r,a&&a.headers||(a.headers={}),a.headers[Ht]=p}catch(e){pe.addException(e)}try{s=e.apply(this,[t,r,a,n])}catch(e){throw o&&(j.setException(o,e),pe.addEvent(o)),e}return j.finalizeEvent(o,i,void 0,{exchange:this.name,host:this.connection.options.host,vhost:this.connection.options.vhost,[Ht]:p,"messaging.message_payload_size_bytes":r.toString().length},{headers:a.headers,message:JSON.stringify(r)}),pe.addEvent(o),s}}var Gt={init(){Ce.patchModule("amqp/lib/exchange.js","publish",amqpProducerWrapper,e=>e.prototype)}};function bindWrapper(e){return function(r,a,n,s){let o,i,p;try{const e=r;"function"==typeof n?(o=n,i=[]):"function"==typeof s&&(o=s,i=n),T.debugLog("LDAP.js bind() wrapper - name: "+e);const a=new y.Resource([this.url.hostname,"ldap","bind"]),c=Date.now(),u=new y.Event(["ldap-"+t(),T.createTimestampFromTime(c),null,"ldap",0,b.ErrorCode.OK]);u.setResource(a);const d=T.flatten({enduser:{id:e},ldap:{strict_dn:T.getValueIfExist(this.url,"strictDN")},net:{transport:"IP.TCP",protocol:T.getValueIfExist(this.url,"protocol"),socket_path:T.getValueIfExist(this.url,"socketPath"),timeout:T.getValueIfExist(this.url,"timeout"),connect_timeout:T.getValueIfExist(this.url,"connectTimeout"),tls_options:T.getValueIfExist(this.url,"tlsOptions"),idle_timeout:T.getValueIfExist(this.url,"idleTimeout"),pathname:T.getValueIfExist(this.url,"pathname"),secure:T.getValueIfExist(this.url,"secure"),peer:{address:T.getValueIfExist(this.url,"href"),hostname:T.getValueIfExist(this.url,"hostname"),port:T.getValueIfExist(this.url,"port"),service:"ldap"}}});j.addToMetadata(u,d);const l=new Promise(e=>{p=(t,r)=>{u.setDuration(T.createDurationTimestamp(c)),t&&j.setException(u,t),e(),o&&o(t,r)}});pe.addEvent(u,l)}catch(e){pe.addException(e)}return e.apply(this,[r,a,i,p])}}var Jt={init(){Ce.patchModule("ldapjs","bind",bindWrapper,e=>e.Client.prototype)}};const{parse:Qt}=it;function cassandraClientWrapper(e){return function(t,r,a,n){let s,o,i,p,c,u="execute";try{const e=Qt(t);u=e.type,p=e.from.length&&e.from[0].table}catch(e){T.debugLog("could not extract cassandra operation "+e)}try{const{slsEvent:e,startTime:t}=j.initializeEvent("cassandra",this.options.contactPoints[0],u,"cassandra-driver");o=e,i=t}catch(e){pe.addException(e)}this.options.keyspace&&j.addToMetadata(o,{"db.cassandra.keyspace":this.options.keyspace}),this.options.localDataCenter&&j.addToMetadata(o,{"db.cassandra.coordinator.dc":this.options.localDataCenter}),p&&j.addToMetadata(o,{"db.cassandra.table":p});const d=new Promise(e=>{c=(a,s)=>{let p;try{if(!o)return T.debugLog("Could not initialize cassandra, skipping response."),p;j.finalizeEvent(o,i,a,{"db.name":this.options.contactPoints[0],"db.operation":u},{"db.statement":t,"db.cassandra.params":r})}catch(e){pe.addException(e)}finally{n&&"function"==typeof n&&(p=n(a,s))}return e(),p}});try{s=e.apply(this,[t,r,a,c])}catch(e){throw o&&(j.setException(o,e),pe.addEvent(o)),e}return o&&pe.addEvent(o,d),s}}var Vt={init(){Ce.patchModule("cassandra-driver/lib/client","execute",cassandraClientWrapper,e=>e.prototype)}};function wrapFsWriteFileFunction(e,t){return function(r,a,n,s){const o="object"==typeof r?r.toString():r,i="function"==typeof(s||n)&&(s||n),{slsEvent:p,startTime:c}=j.initializeEvent("file_system",o,t,"file_system");if(j.addToMetadata(p,{"fs.file":o}),n&&"object"==typeof n&&j.addToMetadata(p,{options:n}),!i)return function(e,t,r,a){try{return pe.addEvent(r),e.apply(this,a)}catch(e){throw j.finalizeEvent(r,t,e),e}}(e,c,p,[o,a,n]);let u,d,l;try{const t=new Promise(e=>{u=t=>{j.finalizeEvent(p,c,t),e(),i(t)}});"function"==typeof s?(l=!0,d=e.apply(this,[r,a,n,u])):"function"==typeof n&&(l=!0,d=e.apply(this,[r,a,u])),pe.addEvent(p,t)}catch(e){pe.addException(e)}return d||l?d:e.apply(this,[r,a,n,s])}}var Zt={init(){"TRUE"===(process.env.EPSAGON_FS_INSTRUMENTATION||"").toUpperCase()&&(Ce.patchSingle(n,"writeFile",()=>wrapFsWriteFileFunction(n.writeFile,"writeFile")),Ce.patchSingle(n,"writeFileSync",()=>wrapFsWriteFileFunction(n.writeFileSync,"writeFileSync")))}};const Xt={"aws-sdk/global":De,"azure-sdk":Bt,"winston-cw":ae,http:Je,http2:ot,pg:ut,mysql:dt,redis:bt,ioredis:yt,mongo:vt,dax:ke,openwhisk:lt,google:ht,dns:St,nats:Ot,myqq:wt,kafkajs:It,kafkanode:kt,bunyan:Wt,pino:qt,winston:jt,amqplib:zt,amqp:Gt,ldap:Jt,cassandra:Vt,fs:Zt};function patch(e){try{e.init()}catch(e){"TRUE"===(process.env.EPSAGON_DEBUG||"").toUpperCase()&&T.debugLog(e)}}B.getConfig().isEpsagonPatchDisabled||(B.getConfig().patchWhitelist?B.getConfig().patchWhitelist.forEach(e=>{Xt[e]?(T.debugLog("[PATCHER] Whitelisting "+e),patch(Xt[e])):T.debugLog("[PATCHER] Unable to find lib to patch: "+e)}):[De,Je,ot,ut,dt,bt,yt,vt,ke,lt,ht,St,Ot,wt,It,kt,Wt,qt,Bt,ae,jt,zt,Gt,Jt,Vt,Zt].forEach(patch));var Yt=createCommonjsModule((function(e){e.exports={lambdaWrapper:e=>e,stepLambdaWrapper:e=>e,openWhiskWrapper:e=>e,nodeWrapper:e=>e,wrapBatchJob:e=>e,label:e=>e,setError:e=>e,setWarning:e=>e,getTraceUrl:e=>e,tracer:pe,config:B,utils:T,eventInterface:j,event:y,tryRequire:Y,errorCode:b,httpHelpers:Re,consts:q,sqsUtils:ue},B.getConfig().isEpsagonDisabled||(e.exports.lambdaWrapper=lambda_lambdaWrapper,e.exports.stepLambdaWrapper=lambda_stepLambdaWrapper,e.exports.nodeWrapper=node_nodeWrapper,e.exports.openWhiskWrapper=openwhisk_openWhiskWrapper,e.exports.wrapBatchJob=batch_wrapBatchJob,e.exports.label=pe.label,e.exports.setError=pe.setError,e.exports.setWarning=pe.setWarning,e.exports.getTraceUrl=pe.getTraceUrl),e.exports.wrapper=ve.wrapper,e.exports.init=pe.initTrace,e.exports.disable=pe.disable,e.exports.unpatch=Ce.unpatchModules,e.exports.enable=pe.enable,e.exports.moduleUtils=Ce})),er=Yt.lambdaWrapper,tr=Yt.stepLambdaWrapper,rr=Yt.openWhiskWrapper,ar=Yt.nodeWrapper,nr=Yt.wrapBatchJob,sr=Yt.label,or=Yt.setError,ir=Yt.setWarning,pr=Yt.getTraceUrl,cr=Yt.tracer,ur=Yt.config,dr=Yt.utils,lr=Yt.eventInterface,gr=Yt.event,fr=Yt.tryRequire,hr=Yt.errorCode,_r=Yt.httpHelpers,mr=Yt.consts,Er=Yt.sqsUtils,br=Yt.wrapper,yr=Yt.init,vr=Yt.disable,$r=Yt.unpatch,Tr=Yt.enable,xr=Yt.moduleUtils;exports.default=Yt,exports.lambdaWrapper=er,exports.stepLambdaWrapper=tr,exports.openWhiskWrapper=rr,exports.nodeWrapper=ar,exports.wrapBatchJob=nr,exports.label=sr,exports.setError=or,exports.setWarning=ir,exports.getTraceUrl=pr,exports.tracer=cr,exports.config=ur,exports.utils=dr,exports.eventInterface=lr,exports.event=gr,exports.tryRequire=fr,exports.errorCode=hr,exports.httpHelpers=_r,exports.consts=mr,exports.sqsUtils=Er,exports.wrapper=br,exports.init=yr,exports.disable=vr,exports.unpatch=$r,exports.enable=Tr,exports.moduleUtils=xr;
